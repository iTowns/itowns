<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Lyon (plane mode)</title>

    <style type="text/css">
            html {height: 100%}
        body { margin: 0; overflow:hidden; height:100%}

            #viewerDiv {
                margin : auto auto;
                width: 100%;
                height: 100%;
                padding: 0;
                /*margin-top: 50vh;
                transform: translateY(-50%);*/
            }
            #menuDiv {position: absolute; top:0px; margin-left: 0px;}
            .ytp-button {
                position: absolute;
                top: 0px;
                right: 0px;
               outline: none;
               border: 0px solid;
               background: transparent;
            }

            .ytp-play-button {
               fill: #fff;
               opacity: 0.85;
            }

            .ytp-play-button:hover {
               cursor: pointer;
               opacity: 1;
            }

        </style>
        <meta charset="UTF-8">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.1/dat.gui.min.js"></script>
    </head>
    <body>
        <div id="viewerDiv"></div>
        <button class="ytp-play-button ytp-button" id="play-button" tabindex="32">
           <svg width="100%" height="100%" viewBox="0 0 36 36" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
              <defs>
                 <path id="ytp-12" d="M 11 10 L 17 10 L 17 26 L 11 26 M 20 10 L 26 10 L 26 26 L 20 26">
                    <animate id="animation" begin="indefinite" attributeType="XML" attributeName="d" fill="freeze" from="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26" to="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28" dur="0.1s" keySplines=".4 0 1 1"
                    repeatCount="1"></animate>
                 </path>
              </defs>
              <use xlink:href="#ytp-12" class="ytp-svg-shadow"></use>
              <use xlink:href="#ytp-12" class="ytp-svg-fill"></use>
           </svg>
        </button>

        <script src="/examples/GUI/GuiTools.js"></script>
        <script src="/dist/itowns.js"></script>
        <script src="/dist/debug.js"></script>
        <script type="text/javascript">

            /* global itowns,document,GuiTools*/
            const viewerDiv = document.getElementById('viewerDiv');

            itowns.proj4.defs('EPSG:3946',
                '+proj=lcc +lat_1=45.25 +lat_2=46.75 +lat_0=46 +lon_0=3 +x_0=1700000 +y_0=5200000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');

            const menuGlobe = new GuiTools('menuDiv');

            const bbox = new itowns.Extent(
                'EPSG:3946',
                1837816.94334, 1847692.32501,
                5170036.4587, 5178412.82698);

            var view = new itowns.PlanarView(viewerDiv, bbox);
            menuGlobe.view = view;
            view.tileLayer.materialOptions = {
                useColorTextureElevation: true,
                // colorTextureElevationMinZ: 148,
                colorTextureElevationMinZ: 37,
                colorTextureElevationMaxZ: 240,
            };
            view.tileLayer.disableSkirt = true;

            view.addLayer({
                url       : "https://download.data.grandlyon.com/wms/grandlyon",
                type      : "color",
                protocol  : 'wms',
                version   : '1.3.0',
                id        : 'wms_imagery',
                name      : 'Ortho2009_vue_ensemble_16cm_CC46',
                style      : "",
                projection : "EPSG:3946",
                transparent : false,
                bbox      : [bbox.west(), bbox.east(), bbox.south(), bbox.north()],
                bbox_url  : "wsen",
                featureInfoMimeType : "",
                dateTime  : "",
                heightMapWidth : 256,
                waterMask      : false,
                updateStrategy: {
                    type: 0,
                    options: {}
                },
                options: {
                    mimetype  : "image/jpeg"
                }
            });

            view.addLayer({
                url       : "https://download.data.grandlyon.com/wms/grandlyon",
                type      : "elevation",
                protocol  : 'wms',
                version   : '1.3.0',
                id        : 'wms_elevation',
                name      : 'MNT2012_Altitude_10m_CC46',
                style      : "",
                projection : "EPSG:3946",
                transparent : false,
                bbox      : [bbox.west(), bbox.east(), bbox.south(), bbox.north()],
                bbox_url  : "wsen",
                featureInfoMimeType : "",
                dateTime  : "",
                heightMapWidth : 256,
                waterMask      : false,
                options: {
                    minmaxElevation: [0, 255],
                    mimetype  : "image/jpeg"
                }
            });

            var animationEnabled = true;

            let previous = Date.now();
            let dt = 0;
            function moveCamera() {
                const now = Date.now();
                dt += now - previous;
                var t = dt / 3000;
                previous = now;

                var radius = Math.min(bbox.dimensions().x, bbox.dimensions().y);// / 2;

                const center = bbox.center().xyz();
                var x = center.x + Math.cos(t) * radius;
                var y = center.y + Math.sin(t) * radius;

                const c2 = new itowns.Coordinates('EPSG:3946', 1842500, 5175500, 0);
                view.camera.camera3D.position.set(x, y, 3000 + Math.sin(t) * 100);
                view.camera.camera3D.lookAt(c2.xyz());
                view.camera.camera3D.updateMatrix();
                view.camera.camera3D.updateMatrixWorld(true);

                view.notifyChange(true);
            }

            view.onAfterRender = () => {
                if (animationEnabled) {
                    moveCamera();
                }
            };
            moveCamera();

            view.notifyChange(true);

            // play-pause button from https://codepen.io/mistkaes/pen/WvPrJL
            pause = "M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28",
            play = "M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26",
            animation = document.getElementById('animation');

            document.getElementById("play-button").addEventListener('click', function() {
                animationEnabled = !animationEnabled;
                animation.setAttribute("from", animationEnabled ? pause : play);
                animation.setAttribute("to", animationEnabled ? play : pause);
                animation.beginElement();
                if (animationEnabled) {
                    view.notifyChange(true);
                    previous = Date.now();
                }
            });

            const contour = new itowns.THREE.Group();

            const l = new itowns.GeometryLayer('outline');
            l.type = 'geometry';
            l.preUpdate = (context, layer, sources) => {
                return contour.children || [];
            };
            l.update = (context, layer, line) => {
                itowns.placeObjectOnGround(view.referenceCrs, view.tileLayer, view.tileLayer.level0Nodes, line);
            };
            itowns.View.prototype.addLayer.call(view, l);

            for (const coords of [bbox.center()]) {
                var group = new itowns.THREE.Group();

                // red cylinder above the ground
                var geometry = new itowns.THREE.BoxGeometry( 10, 10, 500);
                var material = new itowns.THREE.MeshBasicMaterial( {color: 0xff0000} );
                var cylinder = new itowns.THREE.Mesh( geometry, material );
                cylinder.frustumCulled = false;
                cylinder.position.z = 250;
                cylinder.updateMatrix();
                cylinder.layers.set(l.threejsLayer);
                group.add(cylinder);

                // white cylinder under the ground
                material = new itowns.THREE.MeshBasicMaterial( {color: 0xffffff} );
                cylinder = new itowns.THREE.Mesh( geometry, material );
                cylinder.position.z = -250;
                cylinder.frustumCulled = false;
                cylinder.layers.set(l.threejsLayer);
                cylinder.updateMatrix();
                group.add(cylinder);


                const p = coords.xyz();
                group.position.copy(p);
                group.updateMatrix();

                group.updateMatrixWorld(true);
                contour.add(group);
            }
            view.scene.add(contour);


            new debug.Debug(view, viewerDiv);
        </script>
    </body>
</html>
