<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Itowns Examples</title>

    <!-- Code Mirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.css"
        integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Code Mirror Shadowfox dark theme -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/shadowfox.min.css"
        integrity="sha512-Xt1Gi99yJFMZ0ocjkdHqKWLjtb/l8pzJo5cCmHV2GvBFwJiOCLR2HXQBrcFmqY6i8+gXnRaKTGzoBVOl3YUwjw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link cype="text/css" rel="stylesheet" href="css/example.css" />
</head>

<body data-spy="scroll" data-target="nav" onload="onLoad()">
    <!-- Code Mirror Main -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.js"
        integrity="sha512-tXHFLFVaasTvIEFYN8K6UlGvb6Sh1ealAA8YxjpezWMio6u0vU9KfGFzKVth49xh2affuBfmLGY8t2G5pZH+zg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Code Mirror JavaScript support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/javascript/javascript.min.js"
        integrity="sha512-Cbz+kvn+l5pi5HfXsEB/FYgZVKjGIhOgYNBwj4W2IHP2y8r3AdyDCQRnEUqIQ+6aJjygKPTyaNT2eIihaykJlw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Code Mirror XML support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/xml/xml.min.js"
        integrity="sha512-LarNmzVokUmcA7aUDtqZ6oTS+YXmUKzpGdm8DxC46A6AHu+PQiYCUlwEGWidjVYMo/QXZMFMIadZtrkfApYp/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Code Mirror CSS support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/css/css.min.js"
        integrity="sha512-rQImvJlBa8MV1Tl1SXR5zD2bWfmgCEIzTieFegGg89AAt7j/NBEe50M5CqYQJnRwtkjKMmuYgHBqtD1Ubbk5ww=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Code Mirror HTML Mixed support-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/htmlmixed/htmlmixed.min.js"
        integrity="sha512-HN6cn6mIWeFJFwRN9yetDAMSh+AK9myHF1X9GlSlKmThaat65342Yw8wL7ITuaJnPioG0SYG09gy0qd5+s777w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <div id="main">
        <iframe id="content" frameborder="0" height="100%"></iframe>
    </div>

    <div id="editor-panel">
        <div id="editor-header">
            <div>
                <a href="/">
                    <picture id="itowns-logo">
                        <source media="(width <= 1700px)" srcset="./images/itowns_logo.svg" width="245" />
                        <source media="(width > 1700px)" srcset="images/itowns_logo.png" width="245" />
                        <!-- Fallback Image -->
                        <img src="images/itowns_logo.png" width="245px" />
                    </picture>
                </a>
                <label class="switch">
                    <input id="version-switch" type="checkbox" name="version-switch" />
                    <span class="checkmark"></span>
                    Latest
                </label>
            </div>
            <hr />
            <div>
                <select id="example-selector" class="selector"></select>
                <input id="font-size-selector" class="selector" type="number" min="8" step="1" />
                <div>
                    <button type="button" id="run-button" class="header-button" />
                    <button type="button" id="share-button" class="header-button" />
                </div>
            </div>
        </div>
        <hr />
        <div style="display: flex; padding: 1em; height: 100%">
            <textarea id="code-editor"></textarea>
        </div>
    </div>
    <button id="editor-collapse">
        <svg height="10" width="10">
            <polygon points="0,5 10,0 10,10" style="fill:white" />
        </svg>
    </button>

    <script type="text/javascript">
        const iframe = document.getElementById("content");
        const editorPanel = document.getElementById("editor-panel");
        const exampleSelector = document.getElementById("example-selector");
        const codeEditorTextArea = document.getElementById("code-editor");

        /**
         * @param {boolean} isDark - Which theme name to get
         * @returns {string}
         */
        function getTheme(isDark) {
            return isDark ? "shadowfox" : "default";
        }

        const codeEditor = CodeMirror.fromTextArea(codeEditorTextArea, {
            lineNumbers: true,
            mode: "htmlmixed",
            theme: getTheme(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            codeEditor.setOption("theme", getTheme(event.matches));
        });

        const exampleCache = {};

        var baseURI = document.baseURI;
        if (baseURI.includes("/itowns/dev/")) {
            document
                .getElementById("itowns-logo")
                .setAttribute("src", "images/itowns_logo_next.png");
            document
                .getElementById("version-switch")
                .setAttribute("checked", "");
        }

        /**
         * UTF-8 fix to btoa.
         * @param {string} string - A valid UTF-8 string.
         * @returns {string} The encoded string.
         */
        function toBase64(string) {
            return btoa(Array.from(new TextEncoder().encode(string), byte => String.fromCodePoint(byte)).join(""));
        }

        /* UTF-8 fix to atob.
         * @param {string} bytes - A base64-encoded string.
         * @returns {string} The decoded string.
         */
        function fromBase64(bytes) {
            return new TextDecoder().decode(Uint8Array.from(atob(bytes), m => m.codePointAt(0)));
        }

        function runCode() {
            const code = codeEditor.getValue();
            localStorage.setItem("code", toBase64(code));

            iframe.srcdoc = codeEditor.getValue();
        }
        document.getElementById("run-button").onclick = runCode;
        codeEditor.setOption("extraKeys", {
            "Ctrl-Enter": runCode,
        });

        function shareCode() {
            const code = codeEditor.getValue();
            const base64 = toBase64(code);
            localStorage.setItem("code", base64);

            const url = new URL(document.location.toString());
            url.hash = "";
            url.search = "?code=" + encodeURIComponent(base64);
            navigator.clipboard.writeText(url);
        }
        document.getElementById("share-button").onclick = shareCode;

        const fontSizeSelector = document.getElementById("font-size-selector");

        /** @returns {number} - The CodeMirror editor's font size */
        function getEditorFontSize() {
            const editor = document.getElementsByClassName("CodeMirror")[0];
            return parseFloat(window.getComputedStyle(editor, null).getPropertyValue("font-size"));
        }

        /** @param {number} size_px - The new font size to apply */
        function setEditorFontSize(size_px) {
            const size = Math.max(8, Math.round(size_px));
            const editor = document.getElementsByClassName("CodeMirror")[0];
            editor.style.fontSize = `${size}px`;
            // Must release focus to change value
            document.activeElement.blur();
            fontSizeSelector.value = size;
            fontSizeSelector.focus();
        }
        fontSizeSelector.value = getEditorFontSize();
        fontSizeSelector.onchange = (event) => setEditorFontSize(event.target.value || 13);

        let editorHidden = false;
        const editorCollapse = document.getElementById("editor-collapse");
        editorCollapse.onclick = () => {
            if (!editorHidden) {
                editorCollapse.style.left = "0";
                editorCollapse.style.transform = "scaleX(-1)";
                editorPanel.style.left = "calc(-100% * 7 / 16)";
                iframe.style.left = "0";
                iframe.style.width = "100%";
            } else {
                editorCollapse.style.left = "calc(100% * 7 / 16 - 1%)";
                editorCollapse.style.transform = "scaleX(1)";
                editorPanel.style.left = "0";
                iframe.style.left = "";
                iframe.style.width = "calc(100% * 9 / 16)";
            }
            editorHidden = !editorHidden;
        };

        /** @param {string} slug - An example's slug */
        function cacheExample(slug) {
            const src = `https://raw.githubusercontent.com/itowns/itowns/refs/heads/master/examples/${slug}.html`;
            return fetch(src)
                .then((response) => response.text())
                .then((text) => {
                    exampleCache[slug] = text;
                    return text;
                });
        }

        /** @param {string} slug - An example's slug */
        async function loadExample(slug) {
            const example = exampleCache[slug] ?? (await (() => {
                codeEditor.setValue("Loading...");
                return cacheExample(slug);
            })());
            codeEditor.setValue(example);
            window.location.hash = slug;
            window.location.search = "";
            runCode();
        }

        /** @param {Record<string, Record<string, string>>} list - List of examples */
        function initNavigation(list) {
            const nav = document.getElementById("editor-header");
            const versionSwitch = document.getElementById("version-switch");
            if (!baseURI.includes("/itowns/")) {
                versionSwitch.setAttribute("disabled", "");
            } else {
                versionSwitch.onchange = (event) => {
                    window.location.href = document.location.href.replace();
                    const isDev = baseURI.includes("/itowns/dev/");
                    const options = ["/itowns/", "/itowns/dev/"];
                    window.location.href = document.location.href.replace(
                        options[isDev],
                        options[!isDev],
                    );
                };
                if (baseURI.includes("/itowns/dev/")) {
                    versionSwitch.setAttribute("checked", "");
                }
            }

            // Dropdown example selector
            const examples = [
                "<option hidden value='custom'>Custom</option>",
                ...Object.entries(list).flatMap(
                    ([sectionName, section]) => {
                        return [
                            `<optgroup label="${sectionName}">`,
                            ...Object.entries(section).map(
                                ([slug, name]) =>
                                    `<option value=${slug}>${name}</option>`,
                            ),
                            "</optgroup>",
                        ];
                    },
                ),
            ];

            const exampleSelector =
                document.getElementById("example-selector");
            exampleSelector.insertAdjacentHTML(
                "afterbegin",
                examples.join("\n"),
            );
            exampleSelector.onchange = (event) =>
                loadExample(event.target.value);

            const hash = window.location.hash;
            const currentExample = hash.slice(1) || "custom";
            exampleSelector.value = currentExample;
        }

        function onLoad() {
            // Get the configuration
            fetch("./config.json")
                .then(function _(response) {
                    return response.json();
                })
                .then(function _(config) {
                    initNavigation(config);

                    const searchParams = new URL(
                        document.location.toString(),
                    ).searchParams;
                    const urlCode = searchParams.get("code");

                    const localCode = localStorage.getItem("code");

                    if (!urlCode) {
                        if (!localCode) {
                            loadExample(
                                window.location.hash.replace("#", "") ||
                                "view_3d_map",
                            );
                        }
                        else {
                            codeEditor.setValue(fromBase64(localCode));
                            runCode();
                        }
                    } else {
                        codeEditor.setValue(fromBase64(decodeURIComponent(urlCode)));
                        alert('Please check foreign code before running it!');
                    }
                });
        }
    </script>
</body>

</html>
