<html>
    <head>
        <title>Itowns - Point cloud loader (Globe)</title>

        <script type="importmap">
        {
            "imports": {
                "itowns": "../dist/itowns.js",
                "debug": "../dist/debug.js",
                "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/",
                "stats-gl": "https://cdn.jsdelivr.net/npm/stats-gl@2.2.8/dist/main.js"
            }
        }
        </script>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/pointcloud_loader.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="controls">
            <div id="showcase-panel" class="loader-panel">
                <label for="showcase">Play with the showcase</label>
                <select id="showcase" name="showcase">
                    <option value="" selected>Select a dataset...</option>
                    <option value="chicago">Chicago (USGS)</option>
                    <option value="barcelona">Barcelona (ICGC)</option>
                </select>
            </div>

            <form id="load-form" class="loader-panel" method="GET">
                <p class="form-text">Or specify the URL of a point cloud to load:</p>

                <label for="url">URL</label>
                <input type="text" id="url" name="url" required placeholder="Point cloud URL" />

                <label for="format">Format</label>
                <select id="format" name="format">
                    <option value="auto" selected>Auto-detect</option>
                    <option value="ept">Entwine (EPT)</option>
                    <option value="copc">COPC</option>
                    <option value="potree">Potree 1.x</option>
                    <option value="potree2">Potree 2.x</option>
                </select>

                <label for="crs">CRS</label>
                <input id="crs" name="crs" list="crs-list" placeholder="Auto-detect">
                <datalist id="crs-list">
                    <option value="EPSG:4978">EPSG:4978</option>
                </datalist>

                <button type="submit">Load</button>

                <div id="error-message" role="alert"></div>
            </form>
        </div>

        <div id="viewerDiv"></div>

        <script type="module">
            import { Vector3 } from 'three';
            import Stats from 'stats-gl';
            import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
            import { getFormat, getPointCloudClass, getDefaultAttribute, zoomToLayerGlobe } from './jsm/PointCloudHelper.js';

            import {
                CRS, MAIN_LOOP_EVENTS, PNTS_MODE,
                Coordinates,
                View,
                GlobeView,
                Fetcher,
                TMSSource,
                ColorLayer,
                WMTSSource,
                ElevationLayer,
            } from 'itowns';
            import { PointCloudDebug } from 'debug';

            const viewerDiv = document.getElementById('viewerDiv');
            const form = document.getElementById('load-form');
            const urlInput = document.getElementById('url');
            const formatSelect = document.getElementById('format');
            const crsInput = document.getElementById('crs');
            const errorMessage = document.getElementById('error-message');

            async function load(url, options = {}) {
                const { format = 'auto', crs } = options;
                const { Source, Layer } = getPointCloudClass(format);
                const attribute = getDefaultAttribute(format);

                if (crs) {
                    await CRS.fromEPSG(crs);
                }

                const source = new Source({ url, crs });
                await source.whenReady;
                const layer = new Layer('pointcloud', {
                    source,
                    mode: attribute,
                });
                layer.crs = source.crs;

                const view = new GlobeView(viewerDiv, {}, {
                    controls: {
                        minDistance: 5,
                    }
                });
                View.prototype.addLayer.call(view, layer);

                const openSMJSON = await Fetcher.json('./layers/JSONLayers/OPENSM.json');
                view.addLayer(
                    new ColorLayer(openSMJSON.id, {
                        ...openSMJSON,
                        source: new TMSSource(openSMJSON.source),
                    }),
                );

                const worldDTMJSON = await Fetcher.json('./layers/JSONLayers/WORLD_DTM.json');
                view.addLayer(
                    new ElevationLayer(worldDTMJSON.id, {
                        ...worldDTMJSON,
                        source: new WMTSSource(worldDTMJSON.source),
                    }),
                );

                const stats = new Stats();
                stats.init(view.renderer);
                document.body.appendChild(stats.dom);
                view.addFrameRequester(MAIN_LOOP_EVENTS.UPDATE_START, () => stats.begin());
                view.addFrameRequester(MAIN_LOOP_EVENTS.UPDATE_END, () => {
                    stats.end();
                    stats.update()
                });


                await layer.whenReady;
                zoomToLayerGlobe(view, layer);
                if (options.placement) {
                    view.controls.lookAtCoordinate(options.placement, true);
                }

                const gui = new GUI();
                PointCloudDebug.initTools(view, layer, gui);
            }
            const params = new URLSearchParams(window.location.search);
            const url = params.get('url');
            if (url) {
                try {
                    const format = getFormat(url, params.get('format'));
                    const crs = params.get('crs') || undefined;
                    const x = parseFloat(params.get('x'));
                    const y = parseFloat(params.get('y'));
                    const z = parseFloat(params.get('z'));
                    const tilt = parseFloat(params.get('tilt'));
                    const placement = {
                        coord: Number.isFinite(x) && Number.isFinite(y) ? new Coordinates('EPSG:4326', x, y) : undefined,
                        range: Number.isFinite(z) ? z : undefined,
                        tilt: Number.isFinite(tilt) ? tilt : undefined,
                    };
                    urlInput.value = url;
                    formatSelect.value = format ?? 'auto';
                    crsInput.value = crs ?? '';
                    await load(url, { format, crs, placement });
                } catch (error) {
                    console.error(error);
                    const message = error?.message ?? 'Failed to load the point cloud.';
                    form.classList.toggle('error', true);
                    errorMessage.textContent = message;
                }
            }
        </script>

        <script type="module">
            function loadShowcase(showcase) {
                let url;
                let format;
                let crs;
                let x, y, z, tilt;
                switch (showcase) {
                    case 'barcelona':
                        url = 'https://betaserver.icgc.cat/potree12/resources/pointclouds/templesagradafamilia/cloud.js';
                        format = 'potree';
                        crs = 'EPSG:25831';
                        x = 2.174685;
                        y = 41.403596;
                        z = 600;
                        tilt = 50;
                        break;
                    default:
                        url = 'https://s3-us-west-2.amazonaws.com/usgs-lidar-public/USGS_LPC_IL_4County_Cook_2017_LAS_2019/ept.json';
                        format = 'ept';
                        x = -87.6284;
                        y = 41.8855;
                        z = 1300;
                        tilt = 50;
                        break;
                }
                const params = new URLSearchParams();
                params.set('url', url);
                params.set('format', format);
                if (crs) {
                    params.set('crs', crs);
                }
                if (x && y && z && tilt) {
                    params.set('x', x);
                    params.set('y', y);
                    params.set('z', z);
                    params.set('tilt', tilt);
                }
                window.location.search = params.toString();
            }

            document.getElementById('showcase').addEventListener('change', (e) => loadShowcase(e.target.value));
            if (!document.getElementById('url').value) {
                loadShowcase();
            }
        </script>
    </body>
</html>
