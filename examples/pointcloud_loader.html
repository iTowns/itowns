<html>
    <head>
        <title>Itowns - Point cloud loader</title>

        <script type="importmap">
        {
            "imports": {
                "itowns": "../dist/itowns.js",
                "debug": "../dist/debug.js",
                "three": "https://unpkg.com/three@0.182.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.182.0/examples/jsm/",
                "stats-gl": "https://cdn.jsdelivr.net/npm/stats-gl@2.2.8/dist/main.js"
            }
        }
        </script>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/pointcloud_loader.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <form id="load-form" method="GET">
            <p class="form-text">Specify the URL of a point cloud to load</p>

            <label for="url">URL</label>
            <input type="text" id="url" name="url" required placeholder="Point cloud URL" />

            <label for="format">Format</label>
            <select id="format" name="format">
                <option value="auto" selected>Auto-detect</option>
                <option value="ept">Entwine (EPT)</option>
                <option value="copc">COPC</option>
                <option value="potree">Potree 1.x</option>
                <option value="potree2">Potree 2.x</option>
            </select>

            <label for="crs">CRS</label>
            <input id="crs" name="crs" list="crs-list" placeholder="Auto-detect">
            <datalist id="crs-list">
                <option value="EPSG:4978">EPSG:4978</option>
            </datalist>

            <button type="submit">Load</button>

            <div id="error-message" role="alert"></div>
        </form>

        <div id="viewerDiv"></div>

        <script type="module">
            import { Vector3 } from 'three';
            import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
            import Stats from 'stats-gl';
            import { getFormat, getPointCloudClass, zoomToLayer } from './jsm/PointCloudHelper.js';

            import { CRS, MAIN_LOOP_EVENTS, PlanarControls, View } from 'itowns';
            import { PointCloudDebug } from 'debug';

            const viewerDiv = document.getElementById('viewerDiv');
            const form = document.getElementById('load-form');
            const urlInput = document.getElementById('url');
            const formatSelect = document.getElementById('format');
            const crsInput = document.getElementById('crs');
            const errorMessage = document.getElementById('error-message');

            async function load(url, options = {}) {
                const { format = 'auto', crs } = options;
                const { Source, Layer } = getPointCloudClass(format);

                if (crs) {
                    await CRS.fromEPSG(crs);
                }

                const source = new Source({ url, crs });
                await source.whenReady;

                const layer = new Layer('pointcloud', { source });
                layer.crs = source.crs;

                const view = new View(layer.crs, viewerDiv);
                view.renderer.setClearColor(0xdddddd);
                view.addLayer(layer);
                const stats = new Stats();
                stats.init(view.renderer);
                document.body.appendChild(stats.dom);
                view.addFrameRequester(MAIN_LOOP_EVENTS.UPDATE_START, () => stats.begin());
                view.addFrameRequester(MAIN_LOOP_EVENTS.UPDATE_END, () => {
                    stats.end();
                    stats.update()
                });

                await layer.whenReady;
                zoomToLayer(view, layer);

                const controls = new PlanarControls(view);
                controls.groundLevel = layer.minElevationRange;

                const gui = new GUI();
                PointCloudDebug.initTools(view, layer, gui);
            }

            const params = new URLSearchParams(window.location.search);
            const url = params.get('url');
            if (url) {
                try {
                    const format = getFormat(url, params.get('format'));
                    const crs = params.get('crs') || undefined;
                    urlInput.value = url;
                    formatSelect.value = format ?? 'auto';
                    crsInput.value = crs ?? '';
                    await load(url, { format, crs });
                } catch (error) {
                    console.error(error);
                    const message = error?.message ?? 'Failed to load the point cloud.';
                    form.classList.toggle('error', true);
                    errorMessage.textContent = message;
                }
            }
        </script>
    </body>
</html>
