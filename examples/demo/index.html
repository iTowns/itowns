<!DOCTYPE html>
<html>
    <head>
        <title>Itowns - Demonstration</title>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <script type="importmap">
            {
                "imports": {
                    "itowns": "../../dist/itowns.js",
                    "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/",
                    "OrbitControls": "https://unpkg.com/three@0.170.0/examples/jsm/controls/OrbitControls.js"
                }
            }
        </script>

        <link rel="stylesheet" type="text/css" href="../css/example.css" />
        <link
            rel="stylesheet"
            type="text/css"
            href="../css/LoadingScreen.css"
        />
        <link rel="stylesheet" type="text/css" href="../css/widgets.css" />
        <link rel="stylesheet" type="text/css" href="css/demo.css" />
    </head>
    <body>
        <div id="demoUI">
            <div id="textContainer">
                <h1 id="sceneTitle"></h1>
                <p id="sceneDescription"></p>
            </div>
            <div id="navigationContainer">
                <div id="sceneDots"></div>
                <button id="resetScene">reset camera</button>
                <button id="hardResetScene">reset scene</button>
            </div>
        </div>
        <script type="module">
            import * as THREE from "three";
            import * as itowns from "itowns";
            
            let SceneTransitionUtils, SceneRepository;

            try {
                // If webpack served, import from global build
                const mod1 = await import("../../dist/demo.js");
                SceneTransitionUtils = mod1.SceneTransitionUtils;
                SceneRepository = mod1.SceneRepository;
            } catch (e) {
                // Otherwise, import from local build
                const mod2 = await import("./dist/index.js");
                SceneTransitionUtils = mod2.SceneTransitionUtils;
                SceneRepository = mod2.SceneRepository;
            }

            const resetSceneButton = document.getElementById("resetScene");
            const hardResetSceneButton = document.getElementById("hardResetScene");

            SceneTransitionUtils.updateUIForScene(SceneRepository[0]);
            SceneRepository[0].view.setVisible(true);
            await SceneRepository[0].onCreate();
            await SceneRepository[0].onEnter?.();
            const view = SceneRepository[0].view.getView();
            if (view instanceof itowns.GlobeView) {
                view.skyManager.enabled = SceneRepository[0].atmosphere;
            }
            await SceneTransitionUtils.moveCameraTo(view, SceneRepository[0].placement, 0.1);

            let currentIndex = 0;

            const SceneManager = {
                async goTo(index) {
                    if (index === currentIndex || index < 0 || index >= SceneRepository.length) {
                        return;
                    }
                    const from = SceneRepository[currentIndex];
                    const to = SceneRepository[index];
                    currentIndex = index;
                    updateActiveDot();

                    toggleEnableButtons(false);
                    toggleEnableDots(false);
                    try {
                        await SceneTransitionUtils.transitionToScene(from, to);
                    } finally {
                        toggleEnableButtons(true);
                        toggleEnableDots(true);
                    }
                },
                async softReset() {
                    toggleEnableButtons(false);
                    toggleEnableDots(false);
                    try {
                        await SceneTransitionUtils.resetScene(SceneRepository[currentIndex]);
                    } finally {
                        toggleEnableButtons(true);
                        toggleEnableDots(true);
                    }
                },
                async hardReset() {
                    toggleEnableButtons(false);
                    toggleEnableDots(false);
                    try {
                        await SceneTransitionUtils.hardResetScene(SceneRepository[currentIndex]);
                    } finally {
                        toggleEnableButtons(true);
                        toggleEnableDots(true);
                    }
                },
            };

            // ---- Build the dots UI ----
            const dotsContainer = document.getElementById("sceneDots");

            const dots = SceneRepository.map((scene, index) => {
                const dot = document.createElement("div");
                dot.classList.add("scene-dot");
                dot.title = scene.title ?? `Scene ${index + 1}`;
                dot.addEventListener("click", () => {
                    SceneManager.goTo(index);
                });
                dotsContainer.appendChild(dot);
                return dot;
            });

            function toggleEnableButtons(enable) {
                resetSceneButton.style.pointerEvents = enable ? "auto" : "none";
                hardResetSceneButton.style.pointerEvents = enable ? "auto" : "none";
                resetSceneButton.disabled = !enable;
                hardResetSceneButton.disabled = !enable;
            }

            function toggleEnableDots(enable) {
                dots.forEach((dot) => {
                    dot.style.pointerEvents = enable ? "auto" : "none";
                    dot.style.opacity = enable ? "1.0" : "0.5";
                });
            }

            function updateActiveDot() {
                dots.forEach((dot, i) => {
                    if (i === currentIndex) {
                        dot.classList.add("active");
                    } else {
                        dot.classList.remove("active");
                    }
                });
            }

            updateActiveDot();
            resetSceneButton.onclick = async () => {
                await SceneManager.softReset();
            };
            hardResetSceneButton.onclick = async () => {
                await SceneManager.hardReset();
            };
        </script>
    </body>
</html>
