<html>
    <head>
        <title>Itowns - Panorama example</title>

        <style type="text/css">
            html {
                height: 100%;
            }

            body {
                margin: 0;
                overflow: hidden;
                height: 100%;
            }

            #viewerDiv {
                margin : auto auto;
                width: 100%;
                height: 100%;
                padding: 0;
            }
        </style>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="viewerDiv"></div>

        <script src="../dist/itowns.js"></script>

        <script src="../dist/debug.js"></script>
        <script src="GUI/dat.gui/dat.gui.min.js"></script>
        <script type="text/javascript">
            /* global itowns, document, renderer */
            var viewerDiv;
            var view;

            viewerDiv = document.getElementById('viewerDiv');

            const urls = [
                'https://raw.githubusercontent.com/iTowns/iTowns2-sample-data/master/panoramas/arles/metadata1.json',
                'https://raw.githubusercontent.com/iTowns/iTowns2-sample-data/master/panoramas/arles/metadata2.json',
                'https://raw.githubusercontent.com/iTowns/iTowns2-sample-data/master/panoramas/arles/metadata3.json',
                'https://raw.githubusercontent.com/iTowns/iTowns2-sample-data/master/panoramas/arles/metadata4.json',
                'https://raw.githubusercontent.com/iTowns/iTowns2-sample-data/master/panoramas/arles/metadata5.json'];

            const promises = urls.map(url => itowns.Fetcher.json(url, { crossOrigin: 'anonymous' }));

            var activeIndex = 3;
            Promise.all(promises).then((panoramas) => {
                const coordinates = new itowns.Coordinates('EPSG:4326', ...panoramas[0]['coordinates']).as('EPSG:4978');

                view = new itowns.PanoramaView(viewerDiv,
                    coordinates,
                    panoramas[0]['ratio']);

                let index = 0;
                const layers = [];
                for (const pano of panoramas) {
                    let url = new URL(pano['images'], urls[index]);

                    let _id = url.pathname;
                    view.addLayer({
                        visible: index == activeIndex,
                        url: url.href,
                        networkOptions: { crossOrigin: 'anonymous' },
                        type: 'color',
                        protocol: 'static',
                        id: _id,
                        projection: 'EPSG:4326',
                        updateStrategy: {
                            options: {},
                        }
                    });

                    layers.push(view.getLayers(l => l.id == _id)[0]);
                    index ++;
                }
                view.camera.camera3D.far = 10000;
                view.notifyChange(true);

                const gui = new dat.GUI();
                const ddd = new debug.Debug(view, gui);
                debug.createTileDebugUI(gui, view, view.baseLayer, ddd);


                new itowns.FirstPersonControls(view, {
                    focusOnClick: true,
                    panoramaRatio: panoramas[0]['ratio'],
                    moveSpeed: 0,
                });

                document.addEventListener('contextmenu', (evt) => {
                    evt.preventDefault();
                    layers[activeIndex].visible = false;
                    activeIndex = (activeIndex + 1) % 5;
                    layers[activeIndex].visible = true;
                    view.notifyChange(true);
                });
            });
        </script>

    </body>
</html>
