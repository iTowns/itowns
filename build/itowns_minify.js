/**
  @license
  when.js - https://github.com/cujojs/when

  MIT License (c) copyright B Cavalier & J Hann

 * A lightweight CommonJS Promises/A and when() implementation
 * when is part of the cujo.js family of libraries (http://cujojs.com/)
 *
 * Licensed under the MIT License at:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * @version 1.7.1
 */

/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * @license RequireJS text 2.0.14 Copyright (c) 2010-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

define("Core/Commander/Interfaces/EventsManager",[],function(){function e(){this.commands=null,this.events=null,this.timer=null}return e.prototype.connect=function(e,t){},e.prototype.command=function(){},e.prototype.wait=function(){var e=250;this.timer===null?this.timer=window.setTimeout(this.command,e):(window.clearInterval(this.timer),this.timer=window.setTimeout(this.command,e))},e}),THREE.OrbitControls=function(e,t){function O(){return 2*Math.PI/60/60*n.autoRotateSpeed}function M(){return Math.pow(.95,n.zoomSpeed)}function _(e){if(n.enabled===!1)return;e.preventDefault();if(e.button===n.mouseButtons.ORBIT){if(n.noRotate===!0)return;T=x.ROTATE,i.set(e.clientX,e.clientY)}else if(e.button===n.mouseButtons.ZOOM){if(n.noZoom===!0)return;T=x.DOLLY,h.set(e.clientX,e.clientY)}else if(e.button===n.mouseButtons.PAN){if(n.noPan===!0)return;T=x.PAN,u.set(e.clientX,e.clientY)}T!==x.NONE&&(document.addEventListener("mousemove",D,!1),document.addEventListener("mouseup",P,!1),n.dispatchEvent(L))}function D(e){if(n.enabled===!1)return;e.preventDefault();var t=n.domElement===document?n.domElement.body:n.domElement;if(T===x.ROTATE){if(n.noRotate===!0)return;s.set(e.clientX,e.clientY),o.subVectors(s,i),n.rotateLeft(2*Math.PI*o.x/t.clientWidth*n.rotateSpeed),n.rotateUp(2*Math.PI*o.y/t.clientHeight*n.rotateSpeed),i.copy(s)}else if(T===x.DOLLY){if(n.noZoom===!0)return;p.set(e.clientX,e.clientY),d.subVectors(p,h),d.y>0?n.dollyIn():d.y<0&&n.dollyOut(),h.copy(p)}else if(T===x.PAN){if(n.noPan===!0)return;a.set(e.clientX,e.clientY),f.subVectors(a,u),n.pan(f.x,f.y),u.copy(a)}T!==x.NONE&&n.update()}function P(){if(n.enabled===!1)return;document.removeEventListener("mousemove",D,!1),document.removeEventListener("mouseup",P,!1),n.dispatchEvent(A),T=x.NONE}function H(e){if(n.enabled===!1||n.noZoom===!0||T!==x.NONE)return;e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta!==undefined?t=e.wheelDelta:e.detail!==undefined&&(t=-e.detail),t>0?n.dollyOut():t<0&&n.dollyIn(),n.update(),n.dispatchEvent(L),n.dispatchEvent(A)}function B(e){if(n.enabled===!1||n.noKeys===!0||n.noPan===!0)return;switch(e.keyCode){case n.keys.UP:n.pan(0,n.keyPanSpeed),n.update();break;case n.keys.BOTTOM:n.pan(0,-n.keyPanSpeed),n.update();break;case n.keys.LEFT:n.pan(n.keyPanSpeed,0),n.update();break;case n.keys.RIGHT:n.pan(-n.keyPanSpeed,0),n.update()}}function j(e){if(n.enabled===!1)return;switch(e.touches.length){case 1:if(n.noRotate===!0)return;T=x.TOUCH_ROTATE,i.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(n.noZoom===!0)return;T=x.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,s=Math.sqrt(t*t+r*r);h.set(0,s);break;case 3:if(n.noPan===!0)return;T=x.TOUCH_PAN,u.set(e.touches[0].pageX,e.touches[0].pageY);break;default:T=x.NONE}T!==x.NONE&&n.dispatchEvent(L)}function F(e){if(n.enabled===!1)return;e.preventDefault(),e.stopPropagation();var t=n.domElement===document?n.domElement.body:n.domElement;switch(e.touches.length){case 1:if(n.noRotate===!0)return;if(T!==x.TOUCH_ROTATE)return;s.set(e.touches[0].pageX,e.touches[0].pageY),o.subVectors(s,i),n.rotateLeft(2*Math.PI*o.x/t.clientWidth*n.rotateSpeed),n.rotateUp(2*Math.PI*o.y/t.clientHeight*n.rotateSpeed),i.copy(s),n.update();break;case 2:if(n.noZoom===!0)return;if(T!==x.TOUCH_DOLLY)return;var r=e.touches[0].pageX-e.touches[1].pageX,l=e.touches[0].pageY-e.touches[1].pageY,c=Math.sqrt(r*r+l*l);p.set(0,c),d.subVectors(p,h),d.y>0?n.dollyOut():d.y<0&&n.dollyIn(),h.copy(p),n.update();break;case 3:if(n.noPan===!0)return;if(T!==x.TOUCH_PAN)return;a.set(e.touches[0].pageX,e.touches[0].pageY),f.subVectors(a,u),n.pan(f.x,f.y),u.copy(a),n.update();break;default:T=x.NONE}}function I(){if(n.enabled===!1)return;n.dispatchEvent(A),T=x.NONE}this.object=e,this.domElement=t!==undefined?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=Infinity,this.minZoom=0,this.maxZoom=Infinity,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-Infinity,this.maxAzimuthAngle=Infinity,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var n=this,r=1e-6,i=new THREE.Vector2,s=new THREE.Vector2,o=new THREE.Vector2,u=new THREE.Vector2,a=new THREE.Vector2,f=new THREE.Vector2,l=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Vector2,p=new THREE.Vector2,d=new THREE.Vector2,v,m,g=0,y=0,b=1,w=new THREE.Vector3,E=new THREE.Vector3,S=new THREE.Quaternion,x={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},T=x.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom;var N=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),C=N.clone().inverse(),k={type:"change"},L={type:"start"},A={type:"end"};this.rotateLeft=function(e){e===undefined&&(e=O()),y-=e},this.rotateUp=function(e){e===undefined&&(e=O()),g-=e},this.panLeft=function(e){var t=this.object.matrix.elements;l.set(t[0],t[1],t[2]),l.multiplyScalar(-e),w.add(l)},this.panUp=function(e){var t=this.object.matrix.elements;l.set(t[4],t[5],t[6]),l.multiplyScalar(e),w.add(l)},this.pan=function(e,t){var r=n.domElement===document?n.domElement.body:n.domElement;if(n.object instanceof THREE.PerspectiveCamera){var i=n.object.position,s=i.clone().sub(n.target),o=s.length();o*=Math.tan(n.object.fov/2*Math.PI/180),n.panLeft(2*e*o/r.clientHeight),n.panUp(2*t*o/r.clientHeight)}else n.object instanceof THREE.OrthographicCamera?(n.panLeft(e*(n.object.right-n.object.left)/r.clientWidth),n.panUp(t*(n.object.top-n.object.bottom)/r.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){e===undefined&&(e=M()),n.object instanceof THREE.PerspectiveCamera?b/=e:n.object instanceof THREE.OrthographicCamera?(n.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom*e)),n.object.updateProjectionMatrix(),n.dispatchEvent(k)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.dollyOut=function(e){e===undefined&&(e=M()),n.object instanceof THREE.PerspectiveCamera?b*=e:n.object instanceof THREE.OrthographicCamera?(n.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/e)),n.object.updateProjectionMatrix(),n.dispatchEvent(k)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.update=function(){var e=this.object.position;c.copy(e).sub(this.target),c.applyQuaternion(N),v=Math.atan2(c.x,c.z),m=Math.atan2(Math.sqrt(c.x*c.x+c.z*c.z),c.y),this.autoRotate&&T===x.NONE&&this.rotateLeft(O()),v+=y,m+=g,v=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,v)),m=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,m)),m=Math.max(r,Math.min(Math.PI-r,m));var t=c.length()*b;t=Math.max(this.minDistance,Math.min(this.maxDistance,t)),this.target.add(w),c.x=t*Math.sin(m)*Math.sin(v),c.y=t*Math.cos(m),c.z=t*Math.sin(m)*Math.cos(v),c.applyQuaternion(C),e.copy(this.target).add(c),this.object.lookAt(this.target),y=0,g=0,b=1,w.set(0,0,0);if(E.distanceToSquared(this.object.position)>r||8*(1-S.dot(this.object.quaternion))>r)this.dispatchEvent(k),E.copy(this.object.position),S.copy(this.object.quaternion)},this.reset=function(){T=x.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(k),this.update()},this.getPolarAngle=function(){return m},this.getAzimuthalAngle=function(){return v},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",_,!1),this.domElement.addEventListener("mousewheel",H,!1),this.domElement.addEventListener("DOMMouseScroll",H,!1),this.domElement.addEventListener("touchstart",j,!1),this.domElement.addEventListener("touchend",I,!1),this.domElement.addEventListener("touchmove",F,!1),window.addEventListener("keydown",B,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,define("OrbitControls",["THREE"],function(){}),define("Scene/Node",[],function(){function e(){this.parent=null,this.children=[],this.bbox=null,this.url=null,this.content=null,this.description=null,this.id=null,this.saveState=null,this.level=0,this.screenSpaceError=0}return e.prototype.childrenCount=function(){return this.children.length},e.prototype.noChild=function(){return this.children.length===0},e.prototype.update=function(){},e.prototype.hydrate=function(){},e.prototype.dehydrate=function(e){},e.prototype.add=function(e){this.children.push(e)},e.prototype.remove=function(e){},e.extend=function(t){function n(e,t){for(var n in e)if(e[n]===t)return n;return!1}for(var r in e.prototype){var i=n(e.prototype,e.prototype[r]);i!=="add"&&i!=="remove"&&(t.prototype[i]=e.prototype[r])}},e}),define("Renderer/Camera",["Scene/Node","THREE"],function(e,t){function n(n,r,i){e.call(this),this.ratio=n/r,this.FOV=30,this.camera3D=new t.PerspectiveCamera(30,this.ratio,5e3,5e7),this.direction=new t.Vector3,this.frustum=new t.Frustum,this.width=n,this.height=r;var s=this.FOV*Math.PI/180;this.HFOV=2*Math.atan(Math.tan(s*.5)*this.ratio),this.preSSE=this.height*2*Math.tan(this.HFOV*.5),this.cameraHelper=i?new t.CameraHelper(this.camera3D):undefined,this.frustum=new t.Frustum}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.position=function(){return this.camera3D.position},n.prototype.camHelper=function(){return this.cameraHelper},n.prototype.resize=function(e,t){this.ratio=e/t,this.camera3D.aspect=this.ratio,this.camera3D.updateProjectionMatrix()},n.prototype.SSE=function(e){var t=e.geometry.boundingSphere,n=Math.max(0,this.camera3D.position.distanceTo(t.center)-t.radius),r=16,i=Math.pow(2,r-e.level),s=i,o=this.preSSE*(s/n);return o},n.prototype.update=function(){var e=new t.Vector3(0,0,1);this.direction=e.applyQuaternion(this.camera3D.quaternion),this.frustum.setFromMatrix((new t.Matrix4).multiplyMatrices(this.camera3D.projectionMatrix,this.camera3D.matrixWorldInverse))},n.prototype.setPosition=function(e){this.camera3D.position.copy(e)},n.prototype.setRotation=function(e){this.camera3D.quaternion.copy(e)},n.prototype.getFrustum=function(){return this.camera3D.updateMatrix(),this.camera3D.updateMatrixWorld(),this.camera3D.matrixWorldInverse.getInverse(this.camera3D.matrixWorld),this.frustum.setFromMatrix((new t.Matrix4).multiplyMatrices(this.camera3D.projectionMatrix,this.camera3D.matrixWorldInverse)),this.frustum},n}),function(e){e("when",[],function(){function r(e,t,n,r){return i(e).then(t,n,r)}function i(e){var t,n;return e instanceof o?t=e:l(e)?(n=f(),e.then(function(e){n.resolve(e)},function(e){n.reject(e)},function(e){n.progress(e)}),t=n.promise):t=u(e),t}function s(e){return r(e,a)}function o(e){this.then=e}function u(e){var t=new o(function(t){try{return i(t?t(e):e)}catch(n){return a(n)}});return t}function a(e){var t=new o(function(t,n){try{return n?i(n(e)):a(e)}catch(r){return a(r)}});return t}function f(){function h(e,t,n){return u(e,t,n)}function p(e){return c(e)}function d(e){return c(a(e))}function v(e){return l(e)}var e,t,r,s,u,l,c;return t=new o(h),e={then:h,resolve:p,reject:d,progress:v,promise:t,resolver:{resolve:p,reject:d,progress:v}},r=[],s=[],u=function(e,t,n){var i,o;return i=f(),o=typeof n=="function"?function(e){try{i.progress(n(e))}catch(t){i.progress(t)}}:function(e){i.progress(e)},r.push(function(n){n.then(e,t).then(i.resolve,i.reject,o)}),s.push(o),i.promise},l=function(e){return y(s,e),e},c=function(e){return e=i(e),u=e.then,c=i,l=w,y(r,e),s=r=n,e},e}function l(e){return e&&typeof e.then=="function"}function c(e,t,n,i,s){return b(2,arguments),r(e,function(e){function g(e){p(e)}function y(e){h(e)}var o,u,a,l,c,h,p,d,v,m;v=e.length>>>0,o=Math.max(0,Math.min(t,v)),a=[],u=v-o+1,l=[],c=f();if(!o)c.resolve(a);else{d=c.progress,p=function(e){l.push(e),--u||(h=p=w,c.reject(l))},h=function(e){a.push(e),--o||(h=p=w,c.resolve(a))};for(m=0;m<v;++m)m in e&&r(e[m],y,g,d)}return c.then(n,i,s)})}function h(e,t,n,r){function i(e){return t?t(e[0]):e[0]}return c(e,1,i,n,r)}function p(e,t,n,r){return b(1,arguments),v(e,E).then(t,n,r)}function d(){return v(arguments,E)}function v(e,t){return r(e,function(e){var n,i,s,o,u,a;s=i=e.length>>>0,n=[],a=f();if(!s)a.resolve(n);else{o=function(i,o){r(i,t).then(function(e){n[o]=e,--s||a.resolve(n)},a.reject)};for(u=0;u<i;u++)u in e?o(e[u],u):--s}return a.promise})}function m(n,i){var s=t.call(arguments,1);return r(n,function(t){var n;return n=t.length,s[0]=function(e,t,s){return r(e,function(e){return r(t,function(t){return i(e,t,s,n)})})},e.apply(t,s)})}function g(e,t,n){var i=arguments.length>2;return r(e,function(e){return e=i?n:e,t.resolve(e),e},function(e){return t.reject(e),a(e)},t.progress)}function y(e,t){var n,r=0;while(n=e[r++])n(t)}function b(e,t){var n,r=t.length;while(r>e){n=t[--r];if(n!=null&&typeof n!="function")throw new Error("arg "+r+" must be a function")}}function w(){}function E(e){return e}var e,t,n;return r.defer=f,r.resolve=i,r.reject=s,r.join=d,r.all=p,r.map=v,r.reduce=m,r.any=h,r.some=c,r.chain=g,r.isPromise=l,o.prototype={always:function(e,t){return this.then(e,e,t)},otherwise:function(e){return this.then(n,e)},yield:function(e){return this.then(function(){return e})},spread:function(e){return this.then(function(t){return p(t,function(t){return e.apply(n,t)})})}},t=[].slice,e=[].reduce||function(e){var t,n,r,i,s;s=0,t=Object(this),i=t.length>>>0,n=arguments;if(n.length<=1)for(;;){if(s in t){r=t[s++];break}if(++s>=i)throw new TypeError}else r=n[1];for(;s<i;++s)s in t&&(r=e(r,t[s],s,t));return r},r})}(typeof define=="function"&&define.amd?define:function(e){typeof exports=="object"?module.exports=e():this.when=e()}),define("Renderer/c3DEngine",["THREE","OrbitControls","Renderer/Camera","when"],function(e,t,n,r){function s(){if(i!==null)throw new Error("Cannot instantiate more than one c3DEngine");e.ShaderChunk.logdepthbuf_pars_vertex,this.debug=!1,this.scene=undefined,this.scene3D=new e.Scene,this.width=this.debug?window.innerWidth*.5:window.innerWidth,this.height=window.innerHeight,this.renderer=undefined,this.controls=undefined,this.camera=undefined,this.camDebug=undefined,this.initCamera();if(this.debug){var t=new e.AxisHelper(8);this.scene3D.add(t)}this.renderScene=function(){this.renderer.clear(),this.renderer.setViewport(0,0,this.width,this.height),this.renderer.render(this.scene3D,this.camera.camera3D),this.debug&&(this.camera.camHelper().visible=!0,this.renderer.setViewport(this.width,0,this.width,this.height),this.renderer.render(this.scene3D,this.camDebug),this.camera.camHelper().visible=!1)}.bind(this),this.update=function(){this.camera.update(),this.updateControl(),this.scene.wait(),this.renderScene()}.bind(this),this.onWindowResize=function(){this.width=this.debug?window.innerWidth*.5:window.innerWidth,this.height=window.innerHeight,this.camera.resize(this.width,this.height),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderScene()}.bind(this)}var i=null;return s.prototype.initCamera=function(){this.camera=new n(this.width,this.height,this.debug),this.camera.camera3D.position.z=3e7,this.scene3D.add(this.camera.camera3D),this.debug&&(this.camDebug=new e.PerspectiveCamera(30,this.camera.ratio,1,1e9),this.camDebug.position.x=-1e7,this.camDebug.position.y=1e7,this.camDebug.lookAt(new e.Vector3(0,0,0)),this.scene3D.add(this.camera.camHelper()))},s.prototype.initRenderer=function(){this.renderer=new e.WebGLRenderer({antialias:!0,alpha:!0,logarithmicDepthBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(197896),this.renderer.autoClear=!1,document.body.appendChild(this.renderer.domElement)},s.prototype.init=function(e){this.scene=e,this.initRenderer(),this.initControls(),window.addEventListener("resize",this.onWindowResize,!1),this.controls.addEventListener("change",this.update)},s.prototype.updateControl=function(){var e=this.camera.position().length();if(e<8e6){var t=Math.pow(Math.cos((8e6-e)/1621863*Math.PI*.5),1.5);this.controls.zoomSpeed=t,this.controls.rotateSpeed=.8*t}else e>=8e6&&this.controls.zoomSpeed!==1&&(this.controls.zoomSpeed=1,this.controls.rotateSpeed=.8)},s.prototype.style2Engine=function(){},s.prototype.initControls=function(){this.controls=new e.OrbitControls(this.camera.camera3D,this.renderer.domElement),this.controls.target=new e.Vector3(0,0,0),this.controls.damping=.1,this.controls.noPan=!1,this.controls.rotateSpeed=.8,this.controls.zoomSpeed=1,this.controls.minDistance=5e5,this.controls.maxDistance=2e8,this.controls.update()},s.prototype.setTexture=function(t,n){t.material=new e.MeshBasicMaterial({color:16777215,map:n})},s.prototype.add3DScene=function(e){this.scene3D.add(e)},s.prototype.add3Cube=function(t){var n=new e.BoxGeometry(1,1,1),r=new e.MeshBasicMaterial({color:16777215,map:t}),i=new e.Mesh(n,r);this.scene3D.add(i)},s.prototype.precision=function(){},s.prototype.getWindowSize=function(){return new e.Vector2(this.width,this.height)},s.prototype.getRenderer=function(){return this.renderer},function(e){return i=i||new s(e),i}}),define("Renderer/NodeMesh",["Scene/Node","THREE"],function(e,t){var n=function(){e.call(this),t.Mesh.call(this),this.sse=!0};return n.prototype=Object.create(t.Mesh.prototype),n.prototype.constructor=n,e.extend(n),n}),THREE.StarGeometry=function(){THREE.Geometry.call(this);for(var e=0;e<1e4;e++){var t=new THREE.Vector3;t.x=THREE.Math.randFloatSpread(2e10),t.y=THREE.Math.randFloatSpread(2e10),t.z=THREE.Math.randFloatSpread(2e10),this.vertices.push(t)}},THREE.StarGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.StarGeometry.prototype.constructor=THREE.StarGeometry,define("StarGeometry",["THREE"],function(){}),define("Globe/Star",["Renderer/NodeMesh","StarGeometry"],function(e,t){var n=function(){e.call(this);var t=new THREE.StarGeometry,n=new THREE.Points(t,new THREE.PointsMaterial({color:11184844}));this.add(n)};return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n}),define("Core/Commander/Providers/Provider",[],function(){function e(e){this.type=null,this._IoDriver=e}return e.prototype.constructor=e,e.prototype.get=function(e){},e.prototype.getInCache=function(e){},e}),define("Core/Commander/Providers/IoDriver",[],function(){function e(){}return e.prototype.constructor=e,e.prototype.load=function(e){},e.prototype.write=function(e,t){},e.prototype.readAsync=function(e){},e.prototype.writeAsync=function(e){},e}),define("Core/Commander/Providers/IoDriver_XBIL",["Core/Commander/Providers/IoDriver","when"],function(e,t){function n(){e.call(this)}return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.read=function(e){var n=t.defer(),r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="arraybuffer",r.crossOrigin="",r.onload=function(){var e=this.response;if(e){var t=new Float32Array(e),r=0,i=!0;for(var s=0;s<t.byteLength;s++)t[s]===-99999||t[s]===undefined?t[s]=r:i===!0&&(i=!1);i?n.resolve(undefined):n.resolve(t)}},r.onerror=function(){n.reject(Error("Error IoDriver_XBIL"))},r.send(null),n},n}),define("Core/Commander/Providers/CacheRessource",[],function(){function t(){this.cacheObjects=[],this._maximumSize=null}var e=null;return t.prototype.getRessource=function(e){return this.cacheObjects[e]},t.prototype.addRessource=function(e,t){this.cacheObjects[e]=t},t.prototype.getRessourceByID=function(e){},function(){return e=e||new t,e}}),define("Core/Commander/Providers/WMTS_Provider",["Core/Commander/Providers/Provider","Core/Commander/Providers/IoDriver_XBIL","when","THREE","Core/Commander/Providers/CacheRessource"],function(e,t,n,r,i){function s(){e.call(this,new t),this.cache=i(),this.loader=new r.TextureLoader,this.loader.crossOrigin=""}return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype.url=function(e){var t="wmybzw30d6zg563hjlq8eeqb",n="ELEVATION.ELEVATIONGRIDCOVERAGE",r="http://wxs.ign.fr/"+t+"/geoportail/wmts?LAYER="+n+"&FORMAT=image/x-bil;bits=32&SERVICE=WMTS&VERSION=1.0.0"+"&REQUEST=GetTile&STYLE=normal&TILEMATRIXSET=PM"+"&TILEMATRIX="+e.zoom+"&TILEROW="+e.row+"&TILECOL="+e.col;return r},s.prototype.urlOrtho=function(e){var t="i9dpl8xge3jk0a0taex1qrhd",n="ORTHOIMAGERY.ORTHOPHOTOS",r="http://wxs.ign.fr/"+t+"/geoportail/wmts?LAYER="+n+"&FORMAT=image/jpeg&SERVICE=WMTS&VERSION=1.0.0"+"&REQUEST=GetTile&STYLE=normal&TILEMATRIXSET=PM"+"&TILEMATRIX="+e.zoom+"&TILEROW="+e.row+"&TILECOL="+e.col;return r},s.prototype.getTextureBil=function(e){var t=this.url(e),i=this.cache.getRessource(t);return i!==undefined?(i!==-1&&(i.needsUpdate=!0),n(i)):this._IoDriver.read(t).then(function(e){var n;return e===undefined?n=-1:(n=new r.DataTexture(e,256,256,r.AlphaFormat,r.FloatType),n.needsUpdate=!0),this.cache.addRessource(t,n),n}.bind(this))},s.prototype.getTextureOrtho=function(e){var t=this.urlOrtho(e),r=this.cache.getRessource(t);if(r!==undefined)return n(r);var i=this.loader.load(t);return this.cache.addRessource(t,i),n(i)},s}),define("Core/Commander/Queue",[],function(){function e(e,t){this.criteria=e,this.length=0,this.queue=[],this.isMax=!!t,t!==0&&t!==1&&console.log(t+" not supported.")}return e.prototype.insert=function(e){e.hasOwnProperty(this.criteria)||(console.log(e),console.log("Cannot insert "+e+" because it does not have a property by the name of "+this.criteria+".")),this.queue.push(e),this.length++},e.prototype.evaluate=function(e,t){return this.isMax?this.queue[e][this.criteria]>this.queue[t][this.criteria]:this.queue[e][this.criteria]<this.queue[t][this.criteria]},e.prototype.sort=function(){return this.queue=this.queue.sort(function(e,t){return e[this.criteria]>t[this.criteria]?1:e[this.criteria]<t[this.criteria]?-1:0}.bind(this)),this.queue},e}),define("Core/Commander/ManagerCommands",["Core/Commander/Providers/WMTS_Provider","Core/Commander/Interfaces/EventsManager","Core/Commander/Queue"],function(e,t,n){function s(){if(r!==null)throw new Error("Cannot instantiate more than one ManagerCommands");this.queueAsync=new n("priority",1),this.queueSync=null,this.loadQueue=[],this.providers=[],this.history=null,this.providers.push(new e),this.countRequest=0,this.eventsManager=new t,this.scene=undefined}var r=null,i=function(e){this.priority=e};return s.prototype.constructor=s,s.prototype.addCommand=function(e){},s.prototype.requestInc=function(){this.countRequest++},s.prototype.requestDec=function(){this.countRequest--,this.countRequest<=0&&(this.countRequest=0,this.scene.gfxEngine.update())},s.prototype.getTextureBil=function(e){return this.requestInc(),this.providers[0].getTextureBil(e)},s.prototype.getTextureOrtho=function(e){return this.requestInc(),this.providers[0].getTextureOrtho(e)},s.prototype.getTile=function(e,t){},s.prototype.sortByPriority=function(){},s.prototype.removeCanceled=function(){},s.prototype.wait=function(){this.eventsManager.wait()},s.prototype.process=function(){this.scene.updateScene3D()},s.prototype.forecast=function(){},s.prototype.addInHistory=function(e){},function(){return r=r||new s,r}}),define("Core/Commander/Command",[],function(){function e(){this.name=null,this.priority=Math.floor(Math.random()*100),this.state=null,this.inParallel=null,this.inBuffers=null,this.outBuffers=null,this.paramsFunction=[],this.processFunction=null,this.async=null,this.force=null,this.type=null,this.addInHistory=null,this.source=null,this.requester=null}return e.prototype.constructor=e,e.prototype.instance=function(){},e}),define("Core/Commander/InterfaceCommander",["Core/Commander/ManagerCommands","Core/Commander/Command"],function(e,t){function n(t){this.managerCommands=e(),this.type=t}return n.prototype.constructor=n,n.prototype.request=function(e){},n.prototype.buildCommand=function(){this._builderCommand()},n.prototype.getTextureBil=function(e){return this.managerCommands.getTextureBil(e)},n.prototype.getTextureOrtho=function(e){return this.managerCommands.getTextureOrtho(e)},n.prototype.getTile=function(e,n,r){var i=new t;i.type=this.type,i.requester=r,i.paramsFunction.push(e),i.paramsFunction.push(n),this.managerCommands.addCommand(i)},n.prototype.requestDec=function(){this.managerCommands.requestDec()},n}),define("Core/defaultValue",[],function(){var e=function(e,t){return e===undefined?t:e};return e}),define("Core/Geographic/CoordWMTS",["Core/defaultValue"],function(e){function t(t,n,r){this.zoom=e(t,0),this.row=e(n,0),this.col=e(r,0)}return t}),define("Core/Math/MathExtented",["THREE"],function(e){var t={};return t.PI=Math.PI,t.PI_OV_TWO=Math.PI*.5,t.PI_OV_FOUR=Math.PI*.25,t.TWO_PI=Math.PI*2,t.INV_TWO_PI=1/t.TWO_PI,t.LOG_TWO=Math.log(2),t.divideVectors=function(t,n){var r=new e.Vector3(t.x/n.x,t.y/n.y,t.z/n.z);return r},t.lenghtSquared=function(e){return e.x*e.x+e.y*e.y+e.z*e.z},t}),define("Core/Geographic/Projection",["Core/Geographic/CoordWMTS","Core/Math/MathExtented"],function(e,t){function n(){}return n.prototype.WGS84ToPM=function(e,t){},n.prototype.WGS84ToY=function(e){return.5-Math.log(Math.tan(t.PI_OV_FOUR+e*.5))*t.INV_TWO_PI},n.prototype.WGS84LatitudeClamp=function(e){var t=-86/180*Math.PI,n=84/180*Math.PI;return e=Math.max(t,e),e=Math.min(n,e),e},n.prototype.WMTS_WGS84ToWMTS_PM=function(t,n){var r=[],i=t.zoom+1,s=Math.pow(2,i),o=1/s,u=this.WGS84ToY(this.WGS84LatitudeClamp(n.maxCarto.latitude)),a=this.WGS84ToY(this.WGS84LatitudeClamp(n.minCarto.latitude)),f,l,c,h,p,d;p=u/o,d=a/o,f=Math.floor(p),l=Math.floor(d),d-l===0&&l--,c=Math.abs(u-f*o),h=Math.abs(a-l*o);var v=t.col,m=v;return r.push(new e(i,f,v)),r.push(new e(i,l,m)),r},n.prototype.PMToWGS84=function(e,t){},n.prototype.WGS84toWMTS=function(n){var r=Math.floor(Math.log(t.PI/n.dimension.y)/t.LOG_TWO+.5),i=Math.pow(2,r),s=2*i,o=t.TWO_PI/s,u=t.PI/i,a=Math.floor(n.center.x/o),f=Math.floor(i-(t.PI_OV_TWO+n.center.y)/u);return new e(r,f,a)},n.prototype.geoToPM=function(e,t){},n.prototype.geoToWGS84=function(e,t){},n}),define("Scene/Layer",["Scene/Node","Core/Commander/InterfaceCommander","Core/Geographic/Projection"],function(e,t,n){function r(r){e.call(this),this.interCommand=new t(r),this.descriManager=null,this.projection=new n}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r}),define("Core/Math/Point2D",["Core/defaultValue"],function(e){function t(t,n){this.x=e(t,0),this.y=e(n,0)}return t}),define("Core/Geographic/CoordCarto",["Core/defaultValue"],function(e){function t(t,n,r){this.longitude=e(t,0),this.latitude=e(n,0),this.altitude=e(r,0)}return t}),THREE.OBB=function(e,t){THREE.Object3D.call(this),this.box3D=new THREE.Box3(e,t),this.quaInv=this.quaternion.clone().inverse(),this.pointsWorld},THREE.OBB.prototype=Object.create(THREE.Object3D.prototype),THREE.OBB.prototype.constructor=THREE.OBB,THREE.OBB.prototype.update=function(){this.updateMatrix(),this.updateMatrixWorld(),this.quaInv=this.quaternion.clone().inverse(),this.pointsWorld=this.cPointsWorld(this.points())},THREE.OBB.prototype.quadInverse=function(){return this.quaInv},THREE.OBB.prototype.points=function(){var e=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];return e[0].set(this.box3D.min.x,this.box3D.min.y,this.box3D.min.z),e[1].set(this.box3D.min.x,this.box3D.min.y,this.box3D.max.z),e[2].set(this.box3D.min.x,this.box3D.max.y,this.box3D.min.z),e[3].set(this.box3D.min.x,this.box3D.max.y,this.box3D.max.z),e[4].set(this.box3D.max.x,this.box3D.min.y,this.box3D.min.z),e[5].set(this.box3D.max.x,this.box3D.min.y,this.box3D.max.z),e[6].set(this.box3D.max.x,this.box3D.max.y,this.box3D.min.z),e[7].set(this.box3D.max.x,this.box3D.max.y,this.box3D.max.z),e},THREE.OBB.prototype.cPointsWorld=function(e){var t=this.matrixWorld;for(var n=0,r=e.length;n<r;n++)e[n].applyMatrix4(t);return e},define("OBB",["THREE"],function(){}),define("Scene/BoudingBox",["Core/defaultValue","Core/Math/MathExtented","Core/Math/Point2D","Core/Geographic/CoordCarto","THREE","OBB"],function(e,t,n,r,i,s){function o(i,s,o,u,a,f,l){this.minCarto=new r(e(i,0),e(o,-t.PI_OV_TWO),e(f,-1e4)),this.maxCarto=new r(e(s,t.TWO_PI),e(u,t.PI_OV_TWO),e(l,1e4)),this.dimension=new n(Math.abs(this.maxCarto.longitude-this.minCarto.longitude),Math.abs(this.maxCarto.latitude-this.minCarto.latitude)),this.halfDimension=new n(this.dimension.x*.5,this.dimension.y*.5),this.center=new n(this.minCarto.longitude+this.halfDimension.x,this.minCarto.latitude+this.halfDimension.y),this.size=Math.sqrt(this.dimension.x*this.dimension.x+this.dimension.y*this.dimension.y)}return o.prototype.isInside=function(e){},o.prototype.set=function(e,t){this.halfDimension=t,this.center=e},o.prototype.intersect=function(e){return!(this.minCarto.longitude>=e.maxCarto.longitude||this.maxCarto.longitude<=e.minCarto.longitude||this.minCarto.latitude>=e.maxCarto.latitude||this.maxCarto.latitude<=e.minCarto.latitude)},o.prototype.get3DBBox=function(e,t,n){var s=[],o=this.minCarto.longitude,u=this.dimension.x,a=this.minCarto.latitude,f=this.dimension.y;s.push(new r(o,a,0)),s.push(new r(o+this.halfDimension.x,a,0)),s.push(new r(o+u,a,0)),s.push(new r(o+u,a+this.halfDimension.y,0)),s.push(new r(o+u,a+f,0)),s.push(new r(o+this.halfDimension.x,a+f,0)),s.push(new r(o,a+f,0)),s.push(new r(o,a+this.halfDimension.y,0));var l=[],c=[],h=new i.Vector3(-1e3,-1e3,-1e3),p=new i.Vector3(1e3,1e3,1e3),d=0,v=new i.Quaternion,m=new i.Quaternion,g=new i.Vector3,y=new i.Plane(t);v.setFromUnitVectors(t,new i.Vector3(0,1,0)),m.setFromAxisAngle(new i.Vector3(0,1,0),-this.center.x),m.multiply(v);for(var b=0;b<s.length;b++)l.push(e.cartographicToCartesian(s[b])),c.push(y.projectPoint(l[b])),g.subVectors(l[b],n),d=Math.max(d,c[b].distanceTo(g)),c[b].applyQuaternion(m),h.max(c[b]),p.min(c[b]);d*=.5;var w=Math.abs(h.z-p.z)*.5,E=Math.abs(h.x-p.x)*.5,S=E-Math.abs(c[5].x),x=new i.Vector3(w,E,d),T=new i.Vector3(-w,-E,-d),N=new i.OBB(T,x);return N.position.copy(n),N.lookAt(t),N.translateZ(d),N.translateY(S),N.update(),N},o}),define("Core/Geographic/Quad",["Scene/BoudingBox"],function(e){function t(t){this.northWest=new e(t.minCarto.longitude,t.center.x,t.center.y,t.maxCarto.latitude,t.center),this.northEast=new e(t.center.x,t.maxCarto.longitude,t.center.y,t.maxCarto.latitude,t.center),this.southWest=new e(t.minCarto.longitude,t.center.x,t.minCarto.latitude,t.center.y,t.center),this.southEast=new e(t.center.x,t.maxCarto.longitude,t.minCarto.latitude,t.center.y,t.center)}return t.prototype.array=function(){var e=[];return e.push(this.northWest),e.push(this.northEast),e.push(this.southWest),e.push(this.southEast),e},t}),define("text",["module"],function(e){var t,n,r,i,s,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],u=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,f=typeof location!="undefined"&&location.href,l=f&&location.protocol&&location.protocol.replace(/\:/,""),c=f&&location.hostname,h=f&&(location.port||undefined),p={},d=e.config&&e.config()||{};t={version:"2.0.14",strip:function(e){if(e){e=e.replace(u,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:d.createXhr||function(){var e,t,n;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(t=0;t<3;t+=1){n=o[t];try{e=new ActiveXObject(n)}catch(r){}if(e){o=[n];break}}return e},parseName:function(e){var t,n,r,i=!1,s=e.lastIndexOf("."),o=e.indexOf("./")===0||e.indexOf("../")===0;return s!==-1&&(!o||s>1)?(t=e.substring(0,s),n=e.substring(s+1)):t=e,r=n||t,s=r.indexOf("!"),s!==-1&&(i=r.substring(s+1)==="strip",r=r.substring(0,s),n?n=r:t=r),{moduleName:t,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var s,o,u,a=t.xdRegExp.exec(e);return a?(s=a[2],o=a[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===n)&&(!o||o.toLowerCase()===r.toLowerCase())&&(!u&&!o||u===i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,d.isBuild&&(p[e]=r),i(r)},load:function(e,n,r,i){if(i&&i.isBuild&&!i.inlineText){r();return}d.isBuild=i&&i.isBuild;var s=t.parseName(e),o=s.moduleName+(s.ext?"."+s.ext:""),u=n.toUrl(o),a=d.useXhr||t.useXhr;if(u.indexOf("empty:")===0){r();return}!f||a(u,l,c,h)?t.get(u,function(n){t.finishLoad(e,s.strip,n,r)},function(e){r.error&&r.error(e)}):n([o],function(e){t.finishLoad(s.moduleName+"."+s.ext,s.strip,e,r)})},write:function(e,n,r,i){if(p.hasOwnProperty(n)){var s=t.jsEscape(p[n]);r.asModule(e+"!"+n,"define(function () { return '"+s+"';});\n")}},writeFile:function(e,n,r,i,s){var o=t.parseName(n),u=o.ext?"."+o.ext:"",a=o.moduleName+u,f=r.toUrl(o.moduleName+u)+".js";t.load(a,r,function(n){var r=function(e){return i(f,e)};r.asModule=function(e,t){return i.asModule(e,f,t)},t.write(e,a,r,s)},s)}};if(d.env==="node"||!d.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"])n=require.nodeRequire("fs"),t.get=function(e,t,r){try{var i=n.readFileSync(e,"utf8");i[0]==="ï»¿"&&(i=i.substring(1)),t(i)}catch(s){r&&r(s)}};else if(d.env==="xhr"||!d.env&&t.createXhr())t.get=function(e,n,r,i){var s=t.createXhr(),o;s.open("GET",e,!0);if(i)for(o in i)i.hasOwnProperty(o)&&s.setRequestHeader(o.toLowerCase(),i[o]);d.onXhr&&d.onXhr(s,e),s.onreadystatechange=function(t){var i,o;s.readyState===4&&(i=s.status||0,i>399&&i<600?(o=new Error(e+" HTTP status: "+i),o.xhr=s,r&&r(o)):n(s.responseText),d.onXhrComplete&&d.onXhrComplete(s,e))},s.send(null)};else if(d.env==="rhino"||!d.env&&typeof Packages!="undefined"&&typeof java!="undefined")t.get=function(e,t){var n,r,i="utf-8",s=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),u=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),i)),a="";try{n=new java.lang.StringBuffer,r=u.readLine(),r&&r.length()&&r.charAt(0)===65279&&(r=r.substring(1)),r!==null&&n.append(r);while((r=u.readLine())!==null)n.append(o),n.append(r);a=String(n.toString())}finally{u.close()}t(a)};else if(d.env==="xpconnect"||!d.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)r=Components.classes,i=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),s="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var n,o,u,a={};s&&(e=e.replace(/\//g,"\\")),u=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(i.nsIFileInputStream),n.init(u,1,0,!1),o=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(i.nsIConverterInputStream),o.init(n,"utf-8",n.available(),i.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),o.readString(n.available(),a),o.close(),n.close(),t(a.value)}catch(f){throw new Error((u&&u.path||"")+": "+f)}};return t}),define("text!Renderer/Shader/GlobeVS.glsl",[],function(){return"/*\r\n#ifdef USE_LOGDEPTHBUF\r\n    \r\n    #define EPSILON 1e-6\r\n    #ifdef USE_LOGDEPTHBUF_EXT\r\n\r\n        varying float vFragDepth;\r\n\r\n    #endif\r\n\r\n    uniform float logDepthBufFC;\r\n\r\n#endif\r\n*/\r\nuniform sampler2D  dTextures_00[1];\r\nuniform int        nbTextures_00;\r\n\r\nvarying vec2 vUv;\r\nvarying vec3 vNormal;\r\n\r\n\r\n\r\nvoid main() {\r\n\r\n        vUv = uv;\r\n\r\n        if(nbTextures_00 > 0)\r\n        {\r\n            float dv = texture2D( dTextures_00[0], vUv ).w;\r\n\r\n            vNormal  = normalize( position );\r\n\r\n            vec3 displacedPosition = position +  vNormal  * dv;\r\n\r\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( displacedPosition ,1.0 );\r\n        }\r\n        else\r\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position ,1.0 );\r\n\r\n        /*\r\n        #ifdef USE_LOGDEPTHBUF\r\n\r\n            gl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\r\n\r\n            #ifdef USE_LOGDEPTHBUF_EXT\r\n\r\n                vFragDepth = 1.0 + gl_Position.w;\r\n\r\n            #else\r\n\r\n                gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\r\n\r\n            #endif\r\n\r\n        #endif\r\n        */\r\n}   "}),define("text!Renderer/Shader/GlobePS.glsl",[],function(){return"//uniform sampler2D   dTextures_00[1];\r\n\r\nconst int   TEX_UNITS   = 8;\r\nconst float PI          = 3.14159265359;\r\nconst float INV_TWO_PI  = 1.0 / (2.0*PI);\r\nconst float PI2         = 1.57079632679;\r\nconst float PI4         = 0.78539816339;\r\nconst float poleSud     = -82.0 / 180.0 * PI;\r\nconst float poleNord    =  84.0 / 180.0 * PI;\r\n\r\nuniform sampler2D   dTextures_00[1];\r\nuniform sampler2D   dTextures_01[TEX_UNITS];\r\nuniform int         nbTextures_00;\r\nuniform int         nbTextures_01;\r\nuniform vec2        bLongitude; \r\nuniform vec2        bLatitude;\r\nuniform float       periArcLati;\r\nuniform float       y0;\r\nuniform float       zoom;\r\nuniform int         debug;\r\nvarying vec2        vUv;\r\n\r\nvoid main() {\r\n \r\n    float latitude  = bLatitude.x + periArcLati*(1.0-vUv.y);\r\n   \r\n    /*\r\n    float sLine = 0.0015;\r\n    if(vUv.x < sLine || vUv.x > 1.0 - sLine || vUv.y < sLine || vUv.y > 1.0 - sLine)\r\n        gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0);\r\n    else \r\n    */\r\n    \r\n\r\n    if(latitude < poleSud )\r\n        gl_FragColor = vec4( 0.85, 0.85, 0.91, 1.0);\r\n    else\r\n    \r\n    if(latitude > poleNord)\r\n        gl_FragColor = vec4( 0.04, 0.23, 0.35, 1.0);\r\n    else\r\n        {                           \r\n            vec2 uvO ;\r\n            uvO.x           = vUv.x;\r\n            float nbRow     = pow(2.0,zoom + 1.0);\r\n            float y         = 0.5 - log(tan(PI4 + (latitude)*0.5))* INV_TWO_PI;\r\n            uvO.y           = 1.0 - mod(y,1.0/ nbRow)*nbRow;\r\n            float idStart   = floor( y0 * nbRow);\r\n            float idRow     = floor( y  * nbRow);\r\n            int   idd       = int(idRow - idStart);\r\n            vec4  ortho     = vec4( 0.04, 0.23, 0.35, 1.0);\r\n\r\n        \r\n            if(idd >= nbTextures_01)\r\n            {\r\n                idd     = nbTextures_01-1;\r\n                uvO.y   = 0.0;\r\n            }\r\n            else if(idd < 0)\r\n            {\r\n                idd     = 0;\r\n                uvO.y   = 1.0;\r\n            }\r\n\r\n            for (int x = 0; x < TEX_UNITS; x++)\r\n                if (x == idd)\r\n                    ortho  = texture2D( dTextures_01[x], uvO );\r\n\r\n            gl_FragColor = ortho;\r\n\r\n           // if(nbTextures_00 > 0)\r\n           //     gl_FragColor = texture2D( dTextures_00[0], vUv ) /5000.0;\r\n           \r\n\r\n         }      \r\n\r\n         if(debug > 0)\r\n            gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0);\r\n\r\n        \r\n}\r\n\r\n/*\r\nvec4 eleva  = texture2D( dTextures_00[0], vUv);\r\ngl_FragColor = ortho + vec4( eleva.x *1.5,0.0,0.0, 1.0);                        \r\nif(eleva.x == 0.0)\r\n  gl_FragColor = vec4( 0.5, 0.5, 0.5, 1.0);\r\nelse\r\n    gl_FragColor = eleva*2.0;\r\n*/"}),define("Scene/Quadtree",["Scene/Layer","Core/Geographic/CoordWMTS","Core/Geographic/Quad","text!Renderer/Shader/GlobeVS.glsl","text!Renderer/Shader/GlobePS.glsl"],function(e,t,n,r,i){function s(t,n){e.call(this,t),this.schemeTile=n,this.tileType=t;for(var r=0;r<this.schemeTile.rootCount();r++)this.add(this.createTile(this.schemeTile.getRoot(r))),this.subdivide(this.children[r]),this.subdivideChildren(this.children[r])}return s.prototype=Object.create(e.prototype),s.prototype.constructor=s,s.prototype.getMesh=function(){return this.children},s.prototype.northWest=function(e){return e.children[0]},s.prototype.northEast=function(e){return e.children[1]},s.prototype.southWest=function(e){return e.children[2]},s.prototype.southEast=function(e){return e.children[3]},s.prototype.createTile=function(e,n){var s=this.projection.WGS84toWMTS(e);this.interCommand.getTile(e,s,n);var o=new this.tileType(e,r,i,s.zoom);return o.level=s.zoom,this.interCommand.getTextureBil(s).then(function(e){return this.setTextureTerrain(e),this}.bind(o)).then(function(n){this.interCommand.requestDec();if(s.zoom>=2){var r=this.projection.WMTS_WGS84ToWMTS_PM(s,e),i=0,o=r[0].col;for(var u=r[0].row;u<r[1].row+1;u++){var a=new t(r[0].zoom,u,o);this.interCommand.getTextureOrtho(a).then(function(e){this.setTextureOrtho(e,i)}.bind(n)).then(function(){this.interCommand.requestDec()}.bind(this)),i++}}}.bind(this)),o},s.prototype.subdivide=function(e){if(e.level>=11)return;e.material.visible=!1;if(e.childrenCount()!==0){for(var t=0;t<e.childrenCount();t++)e.children[t].visible=!0;return}var r=new n(e.bbox);e.add(this.createTile(r.northWest,e)),e.add(this.createTile(r.northEast,e)),e.add(this.createTile(r.southWest,e)),e.add(this.createTile(r.southEast,e))},s.prototype.subdivideChildren=function(e){if(e.level===3)return;for(var t=0;t<e.children.length;t++)this.subdivide(e.children[t])},s}),define("Scene/SchemeTile",["Scene/BoudingBox"],function(e){function t(){this.maximumChildren=4,this.schemeBB=[]}return t.prototype.add=function(t,n,r,i){return this.schemeBB.push(new e(t,n,r,i))},t.prototype.rootCount=function(){return this.schemeBB.length},t.prototype.getRoot=function(e){return this.schemeBB[e]},t}),define("Core/Math/Ellipsoid",["Core/Math/MathExtented","THREE"],function(e,t){function n(e,n,r){this.rayon_1=e,this.rayon_2=n,this.rayon_3=r,this._radiiSquared=new t.Vector3(e*e,n*n,r*r)}return n.prototype.geodeticSurfaceNormalCartographic=function(e){var n=e.longitude,r=e.latitude,i=Math.cos(r),s=i*Math.cos(-n),o=i*Math.sin(-n),u=Math.sin(r),a=new t.Vector3(s,u,o);return a.normalize()},n.prototype.cartographicToCartesian=function(e){var n=new t.Vector3,r=this.geodeticSurfaceNormalCartographic(e);n.multiplyVectors(this._radiiSquared,r);var i=Math.sqrt(r.dot(n));return n.divideScalar(i),r.multiplyScalar(0),n.add(r)},n.prototype.cartographicToCartesianArray=function(e){var t=[];for(var n=0;n<e.length;n++)t.push(this.cartographicToCartesian(e[n]));return t},n}),define("Globe/EllipsoidTileGeometry",["THREE","Core/defaultValue","Scene/BoudingBox","Core/Math/Ellipsoid","Core/Geographic/CoordCarto"],function(e,t,n,r,i){function s(s){function B(e,t,n,r){d[r+0]=e,d[r+1]=t,d[r+2]=n}e.BufferGeometry.call(this),s=t(s,new n);var o=6.356752314245179,u=new r(6378137,6378137,6356752.314245179),a=128,f=(a+1)*(a+1),l=a*a,c=a,h=a,p=new Float32Array(f*3),d=new Uint32Array(l*3*2),v=new Float32Array(f*3),m=new Float32Array(f*3);c=Math.max(2,Math.floor(c)||2),h=Math.max(2,Math.floor(h)||2);var g=s.minCarto.longitude,y=s.dimension.x,b=s.minCarto.latitude,w=s.dimension.y;this.normals=[],this.HeightPoints=[],this.carto2Normal=function(e,t){return u.geodeticSurfaceNormalCartographic(new i(e,t,0))},this.normals.push(this.carto2Normal(g,b)),this.normals.push(this.carto2Normal(g+y,b+w)),this.normals.push(this.carto2Normal(g,b+w)),this.normals.push(this.carto2Normal(g+y,b)),this.HeightPoints.push(u.cartographicToCartesian(new i(g,b,0))),this.HeightPoints.push(u.cartographicToCartesian(new i(g+s.halfDimension.x,b,0))),this.HeightPoints.push(u.cartographicToCartesian(new i(g+y,b,0))),this.HeightPoints.push(u.cartographicToCartesian(new i(g+y,b+s.halfDimension.y,0))),this.HeightPoints.push(u.cartographicToCartesian(new i(g+y,b+w,0))),this.HeightPoints.push(u.cartographicToCartesian(new i(g+s.halfDimension.x,b+w,0))),this.HeightPoints.push(u.cartographicToCartesian(new i(g,b+w,0))),this.HeightPoints.push(u.cartographicToCartesian(new i(g,b+s.halfDimension.y,0))),this.normal=this.carto2Normal(s.center.x,s.center.y);var E=new i(s.center.x,s.center.y,0);this.center=u.cartographicToCartesian(E),this.OBB=s.get3DBBox(u,this.normal,this.center);var S=0,x,T,N=[],C=[];this.vertices=[];for(T=0;T<=h;T++){var k=[],L=[];for(x=0;x<=c;x++){var A=x/c,O=T/h,M=g+A*y,_=b+O*w,D=u.cartographicToCartesian(new i(M,_,0)),P=S*3;p[P+0]=D.x,p[P+1]=D.y,p[P+2]=D.z;var H=D.clone().normalize();v[P+0]=H.x,v[P+1]=H.y,v[P+2]=H.z,Math.abs(D.y)===o?A+=1/(2*c):Math.abs(D.y)===o&&(A+=1/(2*c)),m[S*2+0]=A,m[S*2+1]=1-O,S++,this.vertices.push(D),k.push(this.vertices.length-1),L.push(new e.Vector2(A,1-O))}N.push(k),C.push(L)}S=0;for(T=0;T<h;T++)for(x=0;x<c;x++){var j=N[T][x+1],F=N[T][x],I=N[T+1][x],q=N[T+1][x+1];B(q,F,j,S),S+=3,B(q,I,F,S),S+=3}this.setIndex(new e.BufferAttribute(d,1)),this.addAttribute("position",new e.BufferAttribute(p,3)),this.addAttribute("normal",new e.BufferAttribute(v,3)),this.addAttribute("uv",new e.BufferAttribute(m,2)),this.computeBoundingSphere()}return s.prototype=Object.create(e.BufferGeometry.prototype),s.prototype.constructor=s,s}),define("Renderer/Material",["THREE","Core/Math/MathExtented"],function(e,t){WGS84LatitudeClamp=function(e){var t=-86/180*Math.PI,n=84/180*Math.PI;return e=Math.max(t,e),e=Math.min(n,e),e};var n=function(n,r,i,s){this.Textures_00=[],this.Textures_00.push(new e.Texture),this.Textures_01=[],this.Textures_01.push(new e.Texture),this.uniforms={dTextures_00:{type:"tv",value:this.Textures_00},dTextures_01:{type:"tv",value:this.Textures_01},nbTextures_00:{type:"i",value:0},nbTextures_01:{type:"i",value:0},bLongitude:{type:"v2",value:new e.Vector2(i.minCarto.longitude,i.maxCarto.longitude)},bLatitude:{type:"v2",value:new e.Vector2(i.minCarto.latitude,i.maxCarto.latitude)},periArcLati:{type:"f",value:Math.abs(i.maxCarto.latitude-i.minCarto.latitude)},y0:{type:"f",value:.5-Math.log(Math.tan(t.PI_OV_FOUR+WGS84LatitudeClamp(i.maxCarto.latitude)*.5))*t.INV_TWO_PI},zoom:{type:"f",value:s},debug:{type:"i",value:!1}},this.shader=new e.ShaderMaterial({uniforms:this.uniforms,vertexShader:n,fragmentShader:r}),this.shader.wireframe=!1};return n.prototype.setTexture=function(e,t,n){t===0?e!==-1&&(this.Textures_00[0]=e,this.uniforms.dTextures_00.value=this.Textures_00,this.uniforms.nbTextures_00.value=1):(this.Textures_01[n]=e,this.uniforms.dTextures_01.value=this.Textures_01,this.uniforms.nbTextures_01.value=this.Textures_01.length),this.shader.needsUpdate=!0},n.prototype.setDebug=function(e){this.uniforms.debug.value=e,this.shader.needsUpdate=!0},n}),define("Globe/EllipsoidTileMesh",["Renderer/NodeMesh","Globe/EllipsoidTileGeometry","Scene/BoudingBox","Core/defaultValue","THREE","Renderer/Material"],function(e,t,n,r,i,s){function o(i,o,u,a){e.call(this),this.showHelper=!0,this.bbox=r(i,new n),this.geometry=new t(i),this.tMat=new s(o,u,i,a),this.material=this.tMat.shader,this.dot=0}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.subdivise=function(e){var t=this.level+1;for(var n=0;n<e.length;n++){var r=new o(e[n]);r.position.set(r.bbox.center.x-this.bbox.center.x,r.bbox.center.y-this.bbox.center.y,0),this.add(r),r.level=t}},o.prototype.setTextureTerrain=function(e){this.tMat.setTexture(e,0)},o.prototype.setTextureOrtho=function(e,t){t=t===undefined?0:t,this.tMat.setTexture(e,1,t)},o.prototype.normals=function(){return this.geometry.normals},o.prototype.fourCorners=function(){return this.geometry.fourCorners},o.prototype.normal=function(){return this.geometry.normal},o.prototype.center=function(){return this.geometry.center},o.prototype.OBB=function(){return this.geometry.OBB},o}),define("text!Renderer/Shader/GlowFS.glsl",[],function(){return"\r\nuniform int atmoIN;\r\nuniform vec2 screenSize;\r\nvarying float intensity;\r\n\r\nvec4 glowColor = vec4(0.45, 0.74, 1. ,1.);\r\n\r\nvoid main() \r\n{\r\n\r\n        float orientedintensity  = intensity * (screenSize.x - gl_FragCoord.x)/(screenSize.x/2.);\r\n        gl_FragColor = glowColor * orientedintensity;\r\n \r\n}\r\n\r\n"}),define("text!Renderer/Shader/GlowVS.glsl",[],function(){return"/*\r\n#ifdef USE_LOGDEPTHBUF\r\n\r\n    #ifdef USE_LOGDEPTHBUF_EXT\r\n\r\n        varying float vFragDepth;\r\n\r\n    #endif\r\n\r\n    uniform float logDepthBufFC;\r\n\r\n#endif\r\n\r\n#define EPSILON 1e-6\r\n*/\r\n\r\nuniform int atmoIN;\r\nvarying float intensity;\r\nvec3 normalES;\r\nvec3 normalCAMES;\r\n\r\nvoid main() \r\n{\r\n    normalES = normalize( normalMatrix * normal );\r\n    normalCAMES = normalize( normalMatrix * cameraPosition );\r\n\r\n    if(atmoIN == 0)\r\n        intensity = pow( 0.55 - dot(normalES, normalCAMES), 4. ); \r\n      else\r\n        intensity = pow( 1.  - dot(normalES, normalCAMES), 0.8 );\r\n\r\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n\r\n    /*\r\n    #ifdef USE_LOGDEPTHBUF\r\n\r\n        gl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\r\n\r\n        #ifdef USE_LOGDEPTHBUF_EXT\r\n\r\n            vFragDepth = 1.0 + gl_Position.w;\r\n\r\n        #else\r\n\r\n            gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\r\n\r\n        #endif\r\n\r\n    #endif\r\n    */\r\n}\r\n\r\n\r\n"}),define("Globe/Atmosphere",["Renderer/NodeMesh","THREE","text!Renderer/Shader/GlowFS.glsl","text!Renderer/Shader/GlowVS.glsl"],function(e,t,n,r){function i(){e.call(this),this.uniformsOut={atmoIN:{type:"i",value:0},screenSize:{type:"v2",value:new t.Vector2(window.innerWidth,window.innerHeight)}},this.material=new t.ShaderMaterial({uniforms:this.uniformsOut,vertexShader:r,fragmentShader:n,side:t.BackSide,blending:t.AdditiveBlending,transparent:!0}),this.geometry=new t.SphereGeometry(73e5,64,64),this.uniformsIn={atmoIN:{type:"i",value:1},screenSize:{type:"v2",value:new t.Vector2(window.innerWidth,window.innerHeight)}};var i=new t.ShaderMaterial({uniforms:this.uniformsIn,vertexShader:r,fragmentShader:n,side:t.FrontSide,blending:t.AdditiveBlending,transparent:!0}),s=new t.Mesh(new t.SphereGeometry(64e5,64,64),i);this.add(s),this.add(new t.Mesh(new t.SphereGeometry(63e5,32,32),new t.MeshBasicMaterial({color:4941882})))}return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i}),define("Globe/Globe",["Scene/Node","Scene/Quadtree","Scene/SchemeTile","Core/Math/MathExtented","Globe/EllipsoidTileMesh","Globe/Atmosphere"],function(e,t,n,r,i,s){function o(){e.call(this),this.terrain=new t(i,this.SchemeTileWMTS(2)),this.add(this.terrain)}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.QuadTreeToMesh=function(){},o.prototype.getMesh=function(){return this.terrain.getMesh()},o.prototype.QuadTreeToMaterial=function(){},o.prototype.SchemeTileWMTS=function(e){if(e===2){var t=new n;return t.add(0,r.PI,-r.PI_OV_TWO,r.PI_OV_TWO),t.add(r.PI,r.TWO_PI,-r.PI_OV_TWO,r.PI_OV_TWO),t}},o}),define("Scene/NodeProcess",["Scene/BoudingBox","Renderer/Camera","Core/Math/MathExtented","THREE"],function(e,t,n,r){function i(i){this.camera=new t,this.camera.camera3D=i.clone(),this.bbox=new e(n.PI_OV_TWO+n.PI_OV_FOUR,n.PI+n.PI_OV_FOUR,0,n.PI_OV_TWO),this.vhMagnitudeSquared=1,this.r=new r.Vector3(6378137,6356752.314245179,6378137),this.cV=new r.Vector3}return i.prototype.backFaceCulling=function(e,t){var n=t.direction;for(var r=0;r<e.normals().length;r++){var i=n.dot(e.normals()[r]);if(i>0)return e.visible=!0,!0}return e.visible=!0,e.visible},i.prototype.setCamera=function(e){this.camera=e},i.prototype.frustumCulling=function(e,t){var n=t.frustum;return n.intersectsObject(e)},i.prototype.SSE=function(e,t){return t.SSE(e)>1},i.prototype.frustumCullingOBB=function(e,t){var n=e.geometry.OBB,r=n.quadInverse().clone();return this.camera.setPosition(n.worldToLocal(t.position().clone())),this.camera.setRotation(r.multiply(t.camera3D.quaternion)),e.visible=this.camera.getFrustum().intersectsBox(n.box3D),e.visible},i.prototype.frustumBB=function(e,t){return e.visible=e.bbox.intersect(this.bbox),e.visible},i.prototype.preHorizonCulling=function(e){this.cV=n.divideVectors(e.position(),this.r),this.vhMagnitudeSquared=n.lenghtSquared(this.cV)-1},i.prototype.pointHorizonCulling=function(e){var t=n.divideVectors(e,this.r),i=new r.Vector3;i.subVectors(t,this.cV);var s=n.lenghtSquared(i),o=-i.dot(this.cV),u=o>this.vhMagnitudeSquared&&o*o/s>this.vhMagnitudeSquared;return u},i.prototype.horizonCulling=function(e){var t=e.OBB().pointsWorld,n=!1;for(var r=0,i=t.length;r<i;r++)this.pointHorizonCulling(t[r])||(n=!0);return e.visible=n,e.visible},i}),define("Scene/BrowseTree",["THREE","Globe/EllipsoidTileMesh","Scene/NodeProcess"],function(e,t,n){function r(e){this.oneNode=0,this.scene=e,this.nodeProcess=new n(this.scene.currentCamera().camera3D),this.tree=undefined}return r.prototype.invisible=function(e){e.visible=!1},r.prototype.processNode=function(e,n,r){if(e instanceof t){e.visible=!1,this.nodeProcess.frustumCullingOBB(e,n);if(e.visible){this.nodeProcess.horizonCulling(e,n);if(e.visible){var i=this.nodeProcess.SSE(e,n);if(e.parent.material!==undefined&&e.parent.material.visible===!0)return e.visible=!1,!1;if(r&&i&&e.material.visible===!0)this.tree.subdivide(e);else if(!i&&e.level>=2&&e.material.visible===!1){e.material.visible=!0;if(e.childrenCount()!==0)for(var s=0;s<e.children.length;s++)e.children[s].visible=!1;return!1}}}return e.visible}return!0},r.prototype.browse=function(e,t,n){this.tree=e,this.nodeProcess.preHorizonCulling(t);for(var r=0;r<e.children.length;r++)this._browse(e.children[r],t,n);n},r.prototype._browse=function(e,t,n){if(this.processNode(e,t,n))for(var r=0;r<e.children.length;r++)this._browse(e.children[r],t,n)},r.prototype.bBoxHelper=function(n){n instanceof t&&n.level<4&&n.noChild()&&(this.oneNode===7&&this.scene.scene3D().add(new e.OBBHelper(n.geometry.OBB)),this.oneNode++)},r.prototype.addOBBoxHelper=function(e){var t=this.bBoxHelper(e);for(var n=0;n<e.children.length;n++)this.addOBBoxHelper(e.children[n]);return t},r}),define("Scene/Scene",["Renderer/c3DEngine","Globe/Star","Globe/Globe","Renderer/NodeMesh","Core/Commander/ManagerCommands","Scene/BrowseTree"],function(e,t,n,r,i,s){function u(){if(o!==null)throw new Error("Cannot instantiate more than one Scene");this.nodes=[],this.cameras=null,this.selectNodes=null,this.managerCommand=i(),this.gfxEngine=e(),this.browserScene=new s(this)}var o=null;return u.prototype.constructor=u,u.prototype.updateCommand=function(){},u.prototype.currentCamera=function(){return this.gfxEngine.camera},u.prototype.init=function(){this.gfxEngine.init(this),this.add(new n),this.managerCommand.scene=this,this.gfxEngine.renderScene()},u.prototype.updateCamera=function(){},u.prototype.sceneProcess=function(){this.nodes[0]!==undefined&&this.currentCamera()!==undefined&&(this.browserScene.browse(this.nodes[0].terrain,this.currentCamera(),!0),this.gfxEngine.update())},u.prototype.realtimeSceneProcess=function(){this.nodes[0]!==undefined&&this.currentCamera!==undefined&&this.browserScene.browse(this.nodes[0].terrain,this.currentCamera(),!1)},u.prototype.updateScene3D=function(){},u.prototype.wait=function(){var e=250;this.realtimeSceneProcess(),this.timer===null?this.timer=window.setTimeout(this.sceneProcess.bind(this),e):(window.clearInterval(this.timer),this.timer=window.setTimeout(this.sceneProcess.bind(this),e))},u.prototype.renderScene3D=function(){this.gfxEngine.renderScene()},u.prototype.scene3D=function(){return this.gfxEngine.scene3D},u.prototype.add=function(e){this.nodes.push(e);if(e instanceof r)this.gfxEngine.add3DScene(e);else if(e instanceof n){var t=e.getMesh();for(var i=0;i<t.length;i++)this.gfxEngine.add3DScene(t[i])}},u.prototype.remove=function(e){},u.prototype.select=function(e){},function(){return o=o||new u,o}}),define("Core/Commander/Interfaces/ApiInterface/ApiGlobe",["Core/Commander/Interfaces/EventsManager","Scene/Scene"],function(e,t){function n(){this.commandsTree=null}return n.prototype=new e,n.prototype.add=function(e){},n.prototype.createCommand=function(e){},n.prototype.execute=function(){},n.CreateSceneGlobe=function(){var e=t();return e.init(),e},n}),requirejs.config({baseUrl:"src/",paths:{text:"ThirdParty/text",THREE:"https://rawgit.com/mrdoob/three.js/master/build/three.min",when:"ThirdParty/when",OrbitControls:"Renderer/Three/OrbitControls",StarGeometry:"Renderer/ThreeExtented/StarGeometry",OBB:"Renderer/ThreeExtented/OBB",OBBHelper:"Renderer/ThreeExtented/OBBHelper"},shim:{THREE:{exports:"THREE"},when:{exports:"when"},OrbitControls:{deps:["THREE"]},StarGeometry:{deps:["THREE"]},OBB:{deps:["THREE"]},OBBHelper:{deps:["THREE"]}},waitSeconds:30}),requirejs(["Core/Commander/Interfaces/ApiInterface/ApiGlobe"],function(e){e.CreateSceneGlobe()}),define("Main",function(){});