<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Globe</title>

	<style type="text/css">
            html {height: 100%}
	    body { margin: 0; overflow:hidden; height:100%}

            #viewerDiv {
                margin : auto auto;
                width: 100%;
                height: 100%;
                padding: 0;
                /*margin-top: 50vh;
                transform: translateY(-50%);*/
            }
            #menuDiv {position: absolute; top:0px; margin-left: 0px;}


        </style>
        <meta charset="UTF-8">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>
    </head>
    <body>
        <div id="viewerDiv"></div>
        <script src="dist/itowns2.js"> </script>
        <script type="text/javascript">


        var initCenter = { longitude:2.3465, latitude: 48.88, altitude: 25000000};

        // iTowns namespace defined here
        var viewerDiv = document.getElementById("viewerDiv");

        var offset = 1000;

        var scene = itowns.viewer.createScenePlane(
            initCenter,
            viewerDiv,
            // pointcloud bouding-box
            [293000 - offset, 294000 + offset, 5041000 - offset, 5042000 + offset]);

        itowns.viewer.addPointCloud("greyhound://3d.oslandia.com/lopocs-itowns/greyhound/");

        itowns.viewer.addImageryLayer({
            url       : "http://3d.oslandia.com/dem.png",
            protocol  : 'single_image',
            id        : 'testsinglpage',
            name      : 'idem',
            projection : "EPSG:3946",
            bbox      : [266040.26, 4984521.41, 343559.74, 5095744.39],
            updateStrategy: {
                type: 0
            },
            options: {
                mimetype  : "image/png",
                tileMatrixSet: 'WGS84G'
            }
        });

        itowns.viewer.addElevationLayer({
            url       : "http://3d.oslandia.com/dem.png",
            protocol  : 'single_image',
            id        : 'testsinglpage',
            name      : 'idem',
            projection : "EPSG:3946",
            bbox      : [266040.26, 4984521.41, 343559.74, 5095744.39],
            updateStrategy: {
                type: 0
            },
            options: {
                minmaxElevation: [0, 255],
                mimetype  : "image/png",
                tileMatrixSet: 'WGS84G'
            }
        });

        itowns.viewer.addImageryLayer({
            url       : "http://geoindex.uqam.ca/mapserv?map=cmm_2013",
            protocol  : 'wms',
            version   : '1.3.0',
            id        : 'testwms',
            name      : 'cmm_2013',
            style      : "",
            projection : "EPSG:2950",
            transparent : true,
            // min long, min lat, max long, max lat
            bbox      : [266040.26, 4984521.41, 343559.74, 5095744.39],
            featureInfoMimeType : "",
            dateTime  : "",
            heightMapWidth : 256,
            waterMask      : false,
            updateStrategy: {
                type: 3
            },
            options: {
                mimetype  : "image/png",
                tileMatrixSet: 'WGS84G'
            }
        });

        itowns.viewer.update();

        // THIS IS AN EXAMPLE OF INTERFACE TO INTERACT WITH ITOWNS
        var Menu = function() {
            this.CloudsIR = false;
            this.SatelliteAnimation = false;
            this.RealisticLighting = false;
            this.StreetLevelImagery = false;
            this.KML = false;
            this.AnimateTime = false;
            this.Orbit = false;
            this.api = function(){};
            this.api2 = function(){};
            this.api3 = function(){};
            this.pointcloud = true;
        };

        var text = new Menu();
        var gui = new dat.GUI( { autoPlace: false});
        gui.domElement.id = 'menuDiv';
        viewerDiv.appendChild(gui.domElement);

        var config = scene.getMap().layersConfiguration;

        var colorGui = gui.addFolder('Color Layers');
        var colorLayers = scene.getMap().layersConfiguration.getColorLayers();
        for(var i in colorLayers) {
            var layer = colorLayers[i];

            var folder = colorGui.addFolder(layer.id);
            folder.add( { visible: true }, 'visible').onChange(function(value) {
                itowns.viewer.setLayerVisibility(this, value);
            }.bind(layer.id));
            folder.add( { opacity: 1.0 }, 'opacity').min(0.0).max(1.0).onChange(function(value) {
                itowns.viewer.setLayerOpacity(this, value);
            }.bind(layer.id));
            folder.add( { frozen: false }, 'frozen').onChange(function(value) {
                config.setLayerFreeze(this, value);
            }.bind(layer.id));
        }

        var elevationGui = gui.addFolder('Elevation Layers');
        var elevationLayers = config.getElevationLayers();
        for(var i in elevationLayers) {
            var layer = elevationLayers[i];

            var folder = elevationGui.addFolder(layer.id);
            folder.add( { frozen: false }, 'frozen').onChange(function(value) {
                config.setLayerFreeze(this, value);
            }.bind(layer.id));
        }

        if(false) {
            var f2 = gui.addFolder('Atmosphere');

            f2.open();

            f2.add(text, 'CloudsIR').onChange(function(newValue) {
                itowns.viewer.showClouds(newValue);
            });

            f2.add(text, 'SatelliteAnimation').onChange(function(newValue) {
                itowns.viewer.showClouds(true, newValue);
            });

            f2.add(text, 'RealisticLighting').onChange(function(newValue) {
                itowns.viewer.setRealisticLightingOn(newValue);
            });

            f2.add(text, 'AnimateTime').onChange(function(newValue) {
                itowns.viewer.animateTime(newValue);
            });

            f2.add(text, 'Orbit').onChange(function(newValue) {
                itowns.viewer.orbit(newValue);
            });


            f2.add(text, 'StreetLevelImagery').onChange(function(newValue) {
                itowns.viewer.setStreetLevelImageryOn(newValue);
            });
        }

        gui.add(text, 'pointcloud').onChange(function(newValue) {
            itowns.viewer.setPointCloudVisibility(newValue);
        });

        viewerDiv.addEventListener('rangeChanged', function() {
            var controller;
            controller = gui.add(text, 'api');
            if(controller) {
                controller.onChange(function(value) {
                    // removeLayer('OPENSM');
                    //itowns.viewer.moveLayerUp('OrthoCRS');
                    //console.log(itowns.viewer.getZoomLevel("Ortho"));
                });
            }
        }, false);

        var removeLayer = function(nameLayer) {
            if(itowns.viewer.removeImageryLayer(nameLayer)) {
                var controllerTodelete = [];

                for (var i in gui.__controllers) {
                    var controller = gui.__controllers[i];

                    if(controller.property === nameLayer ||Â controller.property === nameLayer + '_Opacity') {
                        controllerTodelete.push(controller);
                    }
                }

                for (var i in controllerTodelete) {
                    gui.remove(controllerTodelete[i]);
                }
            }
        }

        var controller;
        var layerIdCrs = 'OrthoCRS';

        // var controller = gui.add(text,'api').name('Up');

        // if(controller)
        // {
        //     controller.onChange(function(value) {
        //         itowns.viewer.moveLayerUp(layerIdCrs);
        //     });
        // }

        // controller = gui.add(text,'api2').name('down');

        // if(controller)
        // {
        //     controller.onChange(function(value) {
        //         itowns.viewer.moveLayerDown(layerIdCrs);
        //     });
        // }

        // controller = gui.add(text,'api3').name('Remove Layer');

        // if(controller)
        // {
        //     controller.onChange(function(value) {
        //         itowns.viewer.removeImageryLayer(layerIdCrs);
        //     });
        // }

        viewerDiv.addEventListener('globe-loaded', function() {
            console.log("Globe Loaded");
            //itowns.viewer.setRange(100000);

            //itowns.viewer.setCenter({longitude:-74,latitude:40,altitude:0});
        }, false);

        viewerDiv.addEventListener('Layer-removed', function(event) {
            console.log("Layer " + event.layer +  " removed");
        }, false);

        // gui.add(text, 'StreetLevelImagery').onChange(function(newValue) {
        //     itowns.viewer.setStreetLevelImageryOn(newValue);
        // });

        </script>
    </body>
</html>
